define("waimai:widget/usercenter/order/commentDialog",function(require,exports,module){function fromTime(t){if(/\d{4}-\d{2}-\d{2}\s+(\d{2}:){1,2}\d{2}/.test(t)){var e=t.split(/\s+/)[0].split("-"),a=t.split(/\s+/)[1].split(":"),i=e[0],o=e[1],d=e[2],s=a[0]||0,n=a[1]||0;return t=new Date(i,o-1,d,s,n).getTime()}return t}var util=require("wcommon:static/util"),cdTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="comment-dialog">    <div class="dialog-wrapper">        <div class="dialog-header">            <h1 class="header-title">评价订单</h1>            <button class="close-btn" data-node="close-btn">╳</button>        </div>        <div class="dialog-row">            <div class="dialog-label">评价</div>            <div class="dailog-content">                <div class="star-wrapper">                    <ul class="comment-star" data-node="comment-star">                        <li data-value="1"></li><li data-value="2"></li><li data-value="3"></li><li data-value="4"></li><li data-value="5"></li>                    </ul>                    <span class="star-notice" data-node="starNotice">点击星星打分</span>                </div>            </div>        </div>         <div class="dialog-row">            <div class="dialog-label">送达时间</div>            <div class="dailog-content">                <select type="text" class="time-selector" data-node="time-selector">                </select>                <span data-node="date-tip"></span>                &nbsp;&nbsp;                <select data-node="time-hour">                </select>                <span>时</span>                <select data-node="time-minute">                </select>                <span>分</span>                <div class="time-notice">本单实际送达时长为<span data-node="delivery-time">40</span>分钟</div>            </div>        </div>         <div class="dialog-row">            <div class="dialog-label vt-top">评论</div>            <div class="dailog-content vt-top">                <textarea class="comment-text placeholder-con" placeholder="您的意见很重要！口味如何？服务怎样？来点评一下吧！" data-node="comment-text">                </textarea>                <span class="comment-text-notice"></span>            </div>        </div>         <div class="dialog-row">            <div class="dialog-label lh-normal">推荐商品</div>            <div class="dailog-content vt-top" data-node="dishes">                <a href="javascript:void(0)" class="dialog-recomm" data-node="dishes-recomm">超级至尊披萨</a>                <a href="javascript:void(0)" class="dialog-recomm" data-node="dishes-recomm">超级至尊披萨</a>                <a href="javascript:void(0)" class="dialog-recomm" data-node="dishes-recomm">超级至尊披萨</a>            </div>        </div>        <div class="dialog-row">            <div class="dialog-label"></div>            <div class="dailog-content">                <button data-node="post-comment">提交评价</button>            </div>        </div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],GlobalTips,_bdstoken=$("#bdstoken").val();module.exports={defaultD:{star:0,time:util.dateFormat(new Date,"yyyy-MM-dd"),comment:"",starDesc:{1:"很差",2:"一般",3:"好",4:"很好",5:"非常好"}},init:function(t,e,a){var i=this;return GlobalTips=t,e.reset(),i.commentCallback=a,i.$el=new e({html:cdTmpl({})}),i.$dialog=i.$el.getElement(),i.initEvent(),i.$stars=i.$dialog.find('[data-node="comment-star"] li'),i.$timeDate=i.$dialog.find('[data-node="time-selector"]'),i.$timeHour=i.$dialog.find('[data-node="time-hour"]'),i.$timeMinute=i.$dialog.find('[data-node="time-minute"]'),i.$starNotice=i.$dialog.find('[data-node="starNotice"]'),i.$starDesc=i.$dialog.find(".star-notice"),i.$commentNotice=i.$dialog.find(".comment-text-notice"),i.starValue=i.defaultD.star,i},_formatNum:function(t){return 10>t?"0"+parseInt(t):t},initEvent:function(){this.$dialog.on("click",'[data-node="close-btn"]',$.proxy(this.hide,this)),this.$dialog.on("mouseenter",'[data-node="comment-star"] li',$.proxy(this.enterStar,this)),this.$dialog.on("mouseout",'[data-node="comment-star"] li',$.proxy(this.outStar,this)),this.$dialog.on("click",'[data-node="comment-star"] li',$.proxy(this.selectStar,this)),this.$dialog.on("click",'[data-node="post-comment"]',$.proxy(this.clickPost,this)),this.$dialog.on("click",'[data-node="dishes-recomm"]',$.proxy(this.selectDish,this)),this.$dialog.on("change",'[data-node="time-selector"]',$.proxy(this.adjustCostTime,this)),this.$dialog.on("change",'[data-node="time-hour"]',$.proxy(this.adjustCostTime,this)),this.$dialog.on("change",'[data-node="time-minute"]',$.proxy(this.adjustCostTime,this)),this.$dialog.on("keyup",'[data-node="comment-text"]',$.proxy(this.inputComment,this))},adjustCostTime:function(t){var e=this,a=$(t.currentTarget);e.adjustReceiveTime(a.data("node")),t.stopPropagation()},inputComment:function(t){var e=this,a=$(t.currentTarget),i=$.trim(a.val()),o=i.length;o>500&&(i=i.substring(0,500),a.val(i),o=i.length),e.$commentNotice.html(o+"/500")},getDashedTime:function(t){var e=new Date(t.split("-")[0],t.split("-")[1]-1,t.split("-")[2]);return e.getTime()},imedTimeSelectBox:function(t){var e=this,a=e.$card.data("createtime"),i=new Date(1e3*a),o=(i.getTime(),i.getHours()),d=i.getMinutes(),s=util.dateFormat(new Date(1e3*a),"yyyy-MM-dd"),n=[],l=0;if("show"==t){e.$timeMinute.prop("disabled",!1);var r=util.dateFormat(new Date(e.getDashedTime(s)+864e5),"yyyy-MM-dd"),m=s;o>23?(n.push('<option value="'+m+'">当天</option>'),n.push('<option value="'+r+'">次日</option>'),e.$timeDate.html(n.join("")).show(),e.$dialog.find('[data-node="date-tip"]').html("")):(n.push('<option value="'+m+'">当天</option>'),util.dateFormat(new Date,"yyyy-MM-dd")==s?(e.$timeDate.html(n.join("")).hide(),e.$dialog.find('[data-node="date-tip"]').html("今天")):(e.$timeDate.html(n.join("")).hide(),e.$dialog.find('[data-node="date-tip"]').html("当天")))}var c=0,u=0,h=e.$timeDate.val()||util.dateFormat(new Date(1e3*a),"yyyy-MM-dd");if("time-selector"==t||"show"==t){h==s&&(l=o),12==Math.ceil(d/5)&&l++,c=l,n=[];for(var p=l;24>p;p++)n.push('<option value="'+this._formatNum(p%24)+'">'+this._formatNum(p%24)+"</option>");e.$timeHour.html(n.join(""))}if("time-selector"==t||"time-hour"==t||"show"==t){var v=e.$timeHour.val();for(n=[],l=0,v==o&&h==s&&(l=Math.ceil(d/5)),12==l&&(l=0),u=l,p=l;12>p;p++)n.push('<option value="'+this._formatNum(5*p)+'">'+this._formatNum(5*p)+"</option>");var $=e.$timeMinute.val();e.$timeMinute.html(n.join("")),e.$timeMinute.val($)}setTimeout(function(){e.$timeMinute.val()||e.$timeMinute.val(e._formatNum(5*u)),e.$timeHour.val()||e.$timeHour.val(e._formatNum(c)),e.$timeDate.val()||e.$timeDate.val(m)},0);var f=e.$timeDate.val()||util.dateFormat(new Date(1e3*a),"yyyy-MM-dd"),g=e.$timeHour.val(),_=e.$timeMinute.val(),y=new Date(f+" "+g+":"+_).getTime();isNaN(y)&&(y=new Date(f[0].split("-")[0],f[0].split("-")[1]-1,f[0].split("-")[2],g,_)),isNaN(y)&&(y=new Date(f.split("-")[0],f.split("-")[1]-1,f.split("-")[2],g,_)),y/=1e3;var D=(y-a)/60;(!D||0>D)&&(D=0),e.$dialog.find(".time-notice").html("本单实际送达时长为"+parseInt(D)+"分钟")},noImedTimeSelectBox:function(t){var e=this,a=3,i=e.$card.data("specialtimeflag"),o=new Date(fromTime(e.$card.data("arrivetime")||e.$card.data("sendtime"))),d=new Date(fromTime(e.$card.data("sendtime"))),s=new Date(fromTime(d)),n=parseInt(s.getHours()),l=(5*Math.ceil(s.getMinutes()/5),60*a*60*1e3),r=d.getTime(),m=util.dateFormat(new Date(r),"yyyy-MM-dd"),c=util.dateFormat(new Date(r+l),"yyyy-MM-dd"),u=util.dateFormat(new Date(r-l),"yyyy-MM-dd");if("show"==t){var h=[];m!==c?(h.push('<option value="'+m+'">'+m+"</option>"),h.push('<option value="'+c+'">'+c+"</option>"),e.$timeDate.html(h.join("")).show(),e.$dialog.find('[data-node="date-tip"]').html("日")):m!==u?(h.push('<option value="'+u+'">'+u+"</option>"),h.push('<option value="'+m+'">'+m+"</option>"),e.$timeDate.html(h.join("")).show(),e.$dialog.find('[data-node="date-tip"]').html("日")):(h.push('<option value="'+m+'">'+m+"</option>"),e.$timeDate.html(h.join("")).hide(),e.$dialog.find('[data-node="date-tip"]').html("当天"))}if("show"==t){for(var p=[],v=n-3;n+4>v;v++){var $=(v+24)%24;v===n-3&&p.push('<option value="'+this._formatNum($)+'|1">早于'+this._formatNum($)+"</option>"),p.push('<option value="'+this._formatNum($)+'">'+this._formatNum($)+"</option>"),v===n+3&&p.push('<option value="'+this._formatNum($)+'|2">晚于'+this._formatNum($)+"</option>")}e.$timeHour.html(p.join(""));var f=[];for(v=0;12>v;v++)f.push('<option value="'+this._formatNum(5*v)+'">'+this._formatNum(5*v)+"</option>");e.$timeMinute.html(f.join("")),e.$timeHour.val(e._formatNum((o.getHours()+24)%24)+(i?"|"+i:"")),e.$timeMinute.val(e._formatNum(o.getMinutes()))}setTimeout(function(){e.$timeHour.val()&&"show"!=t||e.$timeHour.val(e._formatNum((o.getHours()+24)%24)+(i?"|"+i:"")),e.$timeMinute.val()&&"show"!=t||e.$timeMinute.val(e._formatNum(o.getMinutes()))},0);var g=e.$timeDate.val(),_=e.$timeHour.val(),y=_.split("|")[0],D=_.split("|")[1],T=e.$timeMinute.val(),w=new Date(g+" "+y+":"+T).getTime();isNaN(w)&&(w=g&&new Date(g[0].split("-")[0],g[0].split("-")[1]-1,g[0].split("-")[2],y,T)),isNaN(w)&&(w=g&&new Date(g.split("-")[0],g.split("-")[1]-1,g.split("-")[2],y,T));var M=(w-d)/6e4;("time-hour"==t||"show"==t)&&("1"==D||"2"==D?e.$timeMinute.prop("disabled",!0):e.$timeMinute.prop("disabled",!1)),e.$dialog.find(".time-notice").html("1"==D?"这个订单过早送达，我们会反馈给商家和配送人员进行改善":"2"==D?"这个订单延时送达，我们会反馈给商家和配送人员进行改善":Math.abs(M)<30?" ":"这个订单"+(M>0?"延时":"提前")+parseInt(Math.abs(M)||0)+"分钟，我们会反馈给商家和配送人员进行改善")},adjustReceiveTime:function(t){var e=this,a=e.$card.data("imdelivery");a?e.imedTimeSelectBox(t):e.noImedTimeSelectBox(t)},setCard:function(t){var e=this;if(t){e.$card=t;var a=e.$card.find('[data-node="d-score"]').find("span").html();e.commentStar=a,e.starValue=a||e.defaultD.star,e.starDesc=a?e.defaultD.starDesc[e.starValue]:"点击星星打分",e.commValue=$.trim(e.$card.find('[data-node="d-comm"]').html()),e.costTime=e.$card.find('[data-node="c-time"]').html(),e.dTime=e.$card.find('[data-node="d-date"]').html(),e.cTime=e.$card.data("createtime"),e.aTime=e.$card.data("arrivetime");var i=e.$card.data("commentid"),o=[],d=[];if(i){var s=e.$card.find('[data-node="dishes-item"]');$.each(s,function(t,e){d.push($(e).html())})}var n=e.$card.find('[data-node="dish"]');$.each(n,function(t,e){var a=$(e).data("origin")||$(e).html();~$.inArray(a,o)||o.push(a)}),e.recoDishes=o,e.hdis=d}},selectDish:function(t){var e=$(t.currentTarget);e.toggleClass("select-dish")},getRecommendDishes:function(){var t=this,e=t.$dialog.find('[data-node="dishes"] .select-dish'),a=[];return $.each(e,function(t,e){a.push($(e).html())}),a.join(",")},clickPost:function(){var t=this,e=t.getStar();return e?void t.postComment():void t.$starNotice.css("color","#ff2d4b")},postComment:function(){var t,e,a,i,o=this,d=o.getStar(),s=o.$timeDate.val(),n=o.$timeHour.val(),l=o.$timeMinute.val(),r=n.split("|"),m=s+" "+r[0]+":"+l,c=(o.$dialog.find('[data-node="delivery-time"]').html(),o.$dialog.find('[data-node="comment-text"]').val()),u=o.$card.data("orderid"),h=o.$card.data("shopid"),p=o.getRecommendDishes();if(c.length>500)return void GlobalTips.topTip("抱歉，最多只能添加500字评论！",!0);if("update"==o.ctype){var e=o.$card.find('[data-nodevalue="d-score"]').html(),v=o.$card.find('[data-node="r-dishes"]').find('[data-node="dishes-item"]'),t=o.$card.data("commentid"),f=[];$.each(v,function(t,e){f.push($(e).html())}),a="/waimai/comment/update?t="+(new Date).getTime(),i={from:"pc",score:d,arrive_time:m,content:c,recommend_dishes:p,comment_id:t,old_recommend_dishes:f.join(","),bdstoken:_bdstoken,old_score:e}}else a="/waimai/comment/add?t="+(new Date).getTime(),i={from:"pc",order_id:u,score:d,arrive_time:m,content:c,recommend_dishes:p,bdstoken:_bdstoken,shop_id:h};n.split("|")[1]&&(i.special_time_flag=n.split("|")[1]),$.ajax({url:a,type:"post",data:i,dataType:"json",success:function(t){0==t.error_no?(o.commentCallback(),o.$card.attr("data-commentid",t.result.comment_id),o.hide()):GlobalTips.topTip(t.error_msg||"更新评论出错，请稍后重试！",!0)},error:function(){GlobalTips.topTip("网络错误，请稍候重试！")}})},selectStar:function(t){var e=$(t.currentTarget),a=e.data("value");this.starValue=a,this.hasSelectStar=!0,this.setStar(a)},enterStar:function(t){var e=$(t.currentTarget),a=e.data("value");this.$starDesc.html(this.defaultD.starDesc[a]),this.setStar(a)},outStar:function(){this.setStar(this.starValue),this.hasSelectStar||this.commentStar||this.$starDesc.html("点击星星打分")},setStar:function(t){this.$starNotice.css("color","");for(var e=this.$stars.length;e>=0;e--){var a=this.$stars.eq(e);t>e?a.addClass("active"):a.removeClass("active")}this.$starDesc.html(this.defaultD.starDesc[t])},getStar:function(){var t=this.$dialog.find('[data-node="comment-star"] .active'),e=t.length;return e},show:function(t,e){var a=this;a.setCard(t),a.adjustReceiveTime("show");var i=a.dTime||"",o=new Date(1e3*a.cTime+24e5),d=util.dateFormat(o,"yyyy-MM-dd hh:mm"),s=a._formatNum(o.getHours()),n=a._formatNum(5*Math.floor(o.getMinutes()/5)),l=i.split(" "),r=(l[0]?l[0]:d,l[1]?l[1].split(":")[0]:s),m=l[1]?5*Math.floor(l[1].split(":")[1]/5):n;a.ctype=e,a.$dialog.find('[data-node="comment-text"]').val(a.commValue||""),a.$dialog.find('[data-node="delivery-time"]').html(a.costTime),a.$dialog.find('[data-node="time-selector"]').val(l[0]||d||a.defaultD.time);var c=a.$card.data("imdelivery");c?(a.$dialog.find('[data-node="time-hour"]').val(r).trigger("change"),a.$dialog.find('[data-node="time-minute"]').val(m).trigger("change")):(a.$dialog.find('[data-node="time-hour"]').val(r),a.$dialog.find('[data-node="time-minute"]').val(m)),a.$dialog.find(".placeholder-con").placeholder();var u=$();$.each(a.recoDishes,function(t,e){var i=$('<a href="javascript:void(0)" class="dialog-recomm" data-node="dishes-recomm">'+e+"</a>");~$.inArray(e,a.hdis)&&i.addClass("select-dish"),u.push(i[0])}),a.$dialog.find('[data-node="dishes"]').html(u),a.setStar(a.starValue),a.commentStar||a.$starDesc.html("点击星星打分"),a.$commentNotice.empty(),a.hasSelectStar=!1,setTimeout(function(){a.$el.show({fade:!0})},100)},clickMask:function(t){this.hide(),t.stopPropagation(),t.preventDefault()},hide:function(){GlobalTips.hide(),this.$el.hide({fade:!0})}}});