;/*!waimai:widget/commit/callback/callback.js*/
define("waimai:widget/commit/callback/callback",function(r,a,e){function o(r){var r=r||{},a="";return 0==r.error_no?(a=c("wm_ordercbsucc_tpl",{phone:r.phone||"",url:"/waimai?qt=orderlist&type=wait"}),addNStat({da_src:"bookBk.success",da_act:"callback"})):"blacklist"==r.error_type?a=c("wm_orderannouce_tpl",{error_msg:r.error_msg}):r.result&&r.result.need_refresh?a=c("wm_pricechange_tpl",{error_msg:r.error_msg}):(a=c("wm_ordercbfail_tpl",{error_msg:r.error_msg||"出错了",url:"/waimai/shop/"+r.shop_id}),addNStat({da_src:"bookBk.error",da_act:"callback"})),a}var t,c=r("wcommon:static/util/Template"),i=(r("jsmod/ui/pagination"),r("wcommon:static/util/DataHelper"),r("wcommon:static/util"),r("jsmod/ui/dialog"));e.exports={orderCallback:function(r){var a=o(r);i.disableKeyEvent(),t=new i({html:a}),t.show({fade:!0})}}});
;/*!waimai:widget/commit/cart/cart.js*/
define("waimai:widget/commit/cart/cart",function(require,exports,module){var cartDC=require("waimai:static/utils/CartDataCenter"),cookie=require("wcommon:static/util/Cookie"),GlobalTips=require("waimai:static/utils/GlobalTips"),localStore=require("waimai:static/utils/store"),Dialog=require("jsmod/ui/dialog"),verifyphone=require("waimai:widget/common/verifyphone/verifyphone"),couponsTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<td class="item-name" colspan="5">    <p>        <span class="checkbox '),dselected&&_template_fun_array.push("sec"),_template_fun_array.push('" name="use_coupon" '),dshow||_template_fun_array.push('style="display:none;"'),_template_fun_array.push("></span><label>使用代金券</label>    </p>    "),conflict_msg&&_template_fun_array.push('    <p class="conflict-text">',"undefined"==typeof conflict_msg?"":baidu.template._encodeHTML(conflict_msg),"</p>    "),_template_fun_array.push('    <div class="coupon-area" '),dselected||_template_fun_array.push('style="display:none;"'),_template_fun_array.push('>        <input type="hidden" name="coupon_id" value="',"undefined"==typeof data.id?"":baidu.template._encodeHTML(data.id),'">        <ul class="coupon-list coupon-other">            ');var weekNames={week_1:"一",week_2:"二",week_3:"三",week_4:"四",week_5:"五",week_6:"六",week_7:"日"};if(data.id){var item=data,use_condition=item.use_condition?JSON.parse(item.use_condition):{},isInvalidation=1==item.is_used||1==item.is_expired||0==item.is_available,category=use_condition.category,cateArr=[],cateStr="";category&&($.each(category,function(){this.name&&cateArr.push(this.name)}),cateStr=cateArr.join("、"));var user=use_condition.user,userStr="";user&&$.isArray(user)&&1===user.length&&1==user[0]&&(userStr="新用户");var shop=use_condition.shop,shopStr="";if(shop){var brand=shop.brand,supply=shop.supply,store=shop.store;$.isArray(store)&&store.length?$.each(store,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t}):$.isArray(supply)&&supply.length?supply[0]&&(shopStr=supply[0].name||""):$.isArray(brand)&&brand.length&&$.each(brand,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t})}var device=use_condition.device,deviceStr="";device&&$.isArray(device)&&1===device.length&&3==device[0]&&(deviceStr="手机App");var period=use_condition.period,dateArr=[],timeStr="",dateLen,dateStr="";if(period){for(var key in period){var curData=period[key];curData&&$.isArray(curData)&&curData[0]&&curData[0].start&&curData[0].stop&&(timeStr||(timeStr=curData[0].start+" 至 "+curData[0].stop),"Mon"==key?-1===$.inArray(1,dateArr)&&dateArr.push(1):"Tue"==key?-1===$.inArray(2,dateArr)&&dateArr.push(2):"Wed"==key?-1===$.inArray(3,dateArr)&&dateArr.push(3):"Thu"==key?-1===$.inArray(4,dateArr)&&dateArr.push(4):"Fri"==key?-1===$.inArray(5,dateArr)&&dateArr.push(5):"Sat"==key?-1===$.inArray(6,dateArr)&&dateArr.push(6):"Sun"==key&&-1===$.inArray(7,dateArr)&&dateArr.push(7))}dateArr.sort(),dateLen=dateArr.length,1===dateLen?dateStr="周"+weekNames["week_"+dateArr[0]]:"1234567"===dateArr.join("")?dateStr="每天":dateLen>1&&7>dateLen&&(dateStr="周"+weekNames["week_"+dateArr[0]]+"至周"+weekNames["week_"+dateArr[dateLen-1]])}_template_fun_array.push('                <li class="coupon-card selected '),isInvalidation&&_template_fun_array.push("disabled"),_template_fun_array.push('" data-node="coupon-card">                    <table>                        <tr>                            <td class="left">                                <div>                                    <div class="sell-price">                                        <span>¥</span><em>',"undefined"==typeof item.amount?"":baidu.template._encodeHTML(item.amount),"</em>                                    </div>                                    "),"0"!=item.limit_amount&&_template_fun_array.push('<div class="limit">满',"undefined"==typeof item.limit_amount?"":baidu.template._encodeHTML(item.limit_amount),"使用</div>"),_template_fun_array.push('                                </div>                            </td>                            <td class="right">                                <div class="name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</div>                                <div class="date">有效期至',"undefined"==typeof item.expiration_time?"":baidu.template._encodeHTML(item.expiration_time),"</div>                                "),dateStr&&timeStr&&_template_fun_array.push('                                    <div class="time">可用时间 ',"undefined"==typeof dateStr?"":baidu.template._encodeHTML(dateStr)," ","undefined"==typeof timeStr?"":baidu.template._encodeHTML(timeStr),"</div>                                "),_template_fun_array.push('                                <ul class="keyword">                                    '),userStr&&_template_fun_array.push("                                        <li>仅","undefined"==typeof userStr?"":baidu.template._encodeHTML(userStr),"使用</li>                                    "),_template_fun_array.push("                                    "),deviceStr&&_template_fun_array.push("                                        <li>仅","undefined"==typeof deviceStr?"":baidu.template._encodeHTML(deviceStr),"使用</li>                                    "),_template_fun_array.push("                                    "),item.is_only_support_spepay_msg&&_template_fun_array.push("                                        <li>","undefined"==typeof item.is_only_support_spepay_msg?"":baidu.template._encodeHTML(item.is_only_support_spepay_msg),"</li>                                    "),_template_fun_array.push("                                    "),cateStr&&_template_fun_array.push("                                        <li>仅","undefined"==typeof cateStr?"":baidu.template._encodeHTML(cateStr),"品类使用</li>                                    "),_template_fun_array.push("                                    "),shopStr&&_template_fun_array.push("                                        <li>仅","undefined"==typeof shopStr?"":baidu.template._encodeHTML(shopStr),"使用</li>                                    "),_template_fun_array.push('                                </ul>                            </td>                        </tr>                    </table>                    <i></i>                </li>                <li class="show-coupon-dialog"><p class="use_other" data-node="userOther"><span>选择其它代金券</span></p></li>            ')}else _template_fun_array.push('                <li class="coupon-item item-other">                    <div class="item-verify">                        <input type="text" name="coupon_password" placeholder="请输入代金券密码" data-node="coupon-input">                        <button data-node="coupon-check" name="verify_btn">验证</button>                    </div>                </li>            ');_template_fun_array.push("        </ul>    </div></td>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],couponsVeryTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="coupon-area">    <ul class="coupon-list coupon-other">        ');var weekNames={week_1:"一",week_2:"二",week_3:"三",week_4:"四",week_5:"五",week_6:"六",week_7:"日"};if(data.id){var item=data,use_condition=item.use_condition?JSON.parse(item.use_condition):{},isInvalidation=1==item.is_used||1==item.is_expired||0==item.is_available,category=use_condition.category,cateArr=[],cateStr="";category&&($.each(category,function(){this.name&&cateArr.push(this.name)}),cateStr=cateArr.join("、"));var user=use_condition.user,userStr="";user&&$.isArray(user)&&1===user.length&&1==user[0]&&(userStr="新用户");var shop=use_condition.shop,shopStr="";if(shop){var brand=shop.brand,supply=shop.supply,store=shop.store;$.isArray(store)&&store.length?$.each(store,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t}):$.isArray(supply)&&supply.length?supply[0]&&(shopStr=supply[0].name||""):$.isArray(brand)&&brand.length&&$.each(brand,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t})}var device=use_condition.device,deviceStr="";device&&$.isArray(device)&&1===device.length&&3==device[0]&&(deviceStr="手机App");var period=use_condition.period,dateArr=[],timeStr="",dateLen,dateStr="";if(period){for(var key in period){var curData=period[key];curData&&$.isArray(curData)&&curData[0]&&curData[0].start&&curData[0].stop&&(timeStr||(timeStr=curData[0].start+" 至 "+curData[0].stop),"Mon"==key?-1===$.inArray(1,dateArr)&&dateArr.push(1):"Tue"==key?-1===$.inArray(2,dateArr)&&dateArr.push(2):"Wed"==key?-1===$.inArray(3,dateArr)&&dateArr.push(3):"Thu"==key?-1===$.inArray(4,dateArr)&&dateArr.push(4):"Fri"==key?-1===$.inArray(5,dateArr)&&dateArr.push(5):"Sat"==key?-1===$.inArray(6,dateArr)&&dateArr.push(6):"Sun"==key&&-1===$.inArray(7,dateArr)&&dateArr.push(7))}dateArr.sort(),dateLen=dateArr.length,1===dateLen?dateStr="周"+weekNames["week_"+dateArr[0]]:"1234567"===dateArr.join("")?dateStr="每天":dateLen>1&&7>dateLen&&(dateStr="周"+weekNames["week_"+dateArr[0]]+"至周"+weekNames["week_"+dateArr[dateLen-1]])}_template_fun_array.push('        <li class="coupon-card '),isInvalidation&&_template_fun_array.push("disabled"),_template_fun_array.push('" data-node="coupon-card">            <table>                <tr>                    <td class="left">                        <div>                            <div class="sell-price">                                <span>¥</span><em>',"undefined"==typeof item.amount?"":baidu.template._encodeHTML(item.amount),"</em>                            </div>                            "),"0"!=item.limit_amount&&_template_fun_array.push('<div class="limit">满',"undefined"==typeof item.limit_amount?"":baidu.template._encodeHTML(item.limit_amount),"使用</div>"),_template_fun_array.push('                        </div>                    </td>                    <td class="right">                        <div class="name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</div>                        <div class="date">有效期至',"undefined"==typeof item.expiration_time?"":baidu.template._encodeHTML(item.expiration_time),"</div>                        "),dateStr&&timeStr&&_template_fun_array.push('                            <div class="time">可用时间 ',"undefined"==typeof dateStr?"":baidu.template._encodeHTML(dateStr)," ","undefined"==typeof timeStr?"":baidu.template._encodeHTML(timeStr),"</div>                        "),_template_fun_array.push('                        <ul class="keyword">                            '),userStr&&_template_fun_array.push("                                <li>仅","undefined"==typeof userStr?"":baidu.template._encodeHTML(userStr),"使用</li>                            "),_template_fun_array.push("                            "),deviceStr&&_template_fun_array.push("                                <li>仅","undefined"==typeof deviceStr?"":baidu.template._encodeHTML(deviceStr),"使用</li>                            "),_template_fun_array.push("                            "),item.is_only_support_spepay_msg&&_template_fun_array.push("                                <li>","undefined"==typeof item.is_only_support_spepay_msg?"":baidu.template._encodeHTML(item.is_only_support_spepay_msg),"</li>                            "),_template_fun_array.push("                            "),cateStr&&_template_fun_array.push("                                <li>仅","undefined"==typeof cateStr?"":baidu.template._encodeHTML(cateStr),"品类使用</li>                            "),_template_fun_array.push("                            "),shopStr&&_template_fun_array.push("                                <li>仅","undefined"==typeof shopStr?"":baidu.template._encodeHTML(shopStr),"使用</li>                            "),_template_fun_array.push("                        </ul>                    </td>                </tr>            </table>            <i></i>        </li>        ")}_template_fun_array.push("    </ul></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],couponsDialogTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';if(eval(_template_varName),_template_fun_array.push('<div id="coupons-dialog">    <div class="title">        <ul data-node="tab">            <li data-content="tabList" class="select">选择现有代金券</li>            <li data-content="tabNew">验证新的代金券</li>        </ul>    </div>    <div class="coupon-area" data-node="tabList">        '),data.length){_template_fun_array.push('            <div class="coupon-div '),data.length>5&&_template_fun_array.push(" max-height"),_template_fun_array.push('">                <ul class="coupon-list">                    ');for(var weekNames={week_1:"一",week_2:"二",week_3:"三",week_4:"四",week_5:"五",week_6:"六",week_7:"日"},i=0,len=data.length;len>i;i++){var item=data[i],use_condition=item.use_condition?JSON.parse(item.use_condition):{},isSelected=item.id==selectId&&0!=item.is_available,isInvalidation=1==item.is_used||1==item.is_expired||0==item.is_available,category=use_condition.category,cateArr=[],cateStr="";category&&($.each(category,function(){this.name&&cateArr.push(this.name)}),cateStr=cateArr.join("、"));var user=use_condition.user,userStr="";user&&$.isArray(user)&&1===user.length&&1==user[0]&&(userStr="新用户");var shop=use_condition.shop,shopStr="";if(shop){var brand=shop.brand,supply=shop.supply,store=shop.store;$.isArray(store)&&store.length?$.each(store,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t}):$.isArray(supply)&&supply.length?supply[0]&&(shopStr=supply[0].name||""):$.isArray(brand)&&brand.length&&$.each(brand,function(){var e=this,t=e&&e.name?e.name:"";shopStr+=t})}var device=use_condition.device,deviceStr="";device&&$.isArray(device)&&1===device.length&&3==device[0]&&(deviceStr="手机App");var period=use_condition.period,dateArr=[],timeStr="",dateLen,dateStr="";if(period){for(var key in period){var curData=period[key];curData&&$.isArray(curData)&&curData[0]&&curData[0].start&&curData[0].stop&&(timeStr||(timeStr=curData[0].start+" 至 "+curData[0].stop),"Mon"==key?-1===$.inArray(1,dateArr)&&dateArr.push(1):"Tue"==key?-1===$.inArray(2,dateArr)&&dateArr.push(2):"Wed"==key?-1===$.inArray(3,dateArr)&&dateArr.push(3):"Thu"==key?-1===$.inArray(4,dateArr)&&dateArr.push(4):"Fri"==key?-1===$.inArray(5,dateArr)&&dateArr.push(5):"Sat"==key?-1===$.inArray(6,dateArr)&&dateArr.push(6):"Sun"==key&&-1===$.inArray(7,dateArr)&&dateArr.push(7))}dateArr.sort(),dateLen=dateArr.length,1===dateLen?dateStr="周"+weekNames["week_"+dateArr[0]]:"1234567"===dateArr.join("")?dateStr="每天":dateLen>1&&7>dateLen&&(dateStr="周"+weekNames["week_"+dateArr[0]]+"至周"+weekNames["week_"+dateArr[dateLen-1]])}_template_fun_array.push('                        <li class="coupon-card '),isSelected&&_template_fun_array.push("selected"),_template_fun_array.push(" "),isInvalidation&&_template_fun_array.push("disabled"),_template_fun_array.push(" "),isSelected||isInvalidation||_template_fun_array.push("selector"),_template_fun_array.push('" data-node="coupon-card" data-id="',"undefined"==typeof item.id?"":baidu.template._encodeHTML(item.id),'" data-index="',"undefined"==typeof i?"":baidu.template._encodeHTML(i),'">                            <table>                                <tr>                                    <td class="left">                                        <div>                                            <div class="sell-price">                                                <span>¥</span><em>',"undefined"==typeof item.amount?"":baidu.template._encodeHTML(item.amount),"</em>                                            </div>                                            "),"0"!=item.limit_amount&&_template_fun_array.push('<div class="limit">满',"undefined"==typeof item.limit_amount?"":baidu.template._encodeHTML(item.limit_amount),"使用</div>"),_template_fun_array.push('                                        </div>                                    </td>                                    <td class="right">                                        <div class="name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</div>                                        <div class="date">有效期至',"undefined"==typeof item.expiration_time?"":baidu.template._encodeHTML(item.expiration_time),"</div>                                        "),dateStr&&timeStr&&_template_fun_array.push('                                            <div class="time">可用时间 ',"undefined"==typeof dateStr?"":baidu.template._encodeHTML(dateStr)," ","undefined"==typeof timeStr?"":baidu.template._encodeHTML(timeStr),"</div>                                        "),_template_fun_array.push('                                        <ul class="keyword">                                            '),userStr&&_template_fun_array.push("                                                <li>仅","undefined"==typeof userStr?"":baidu.template._encodeHTML(userStr),"使用</li>                                            "),_template_fun_array.push("                                            "),deviceStr&&_template_fun_array.push("                                                <li>仅","undefined"==typeof deviceStr?"":baidu.template._encodeHTML(deviceStr),"使用</li>                                            "),_template_fun_array.push("                                            "),item.is_only_support_spepay_msg&&_template_fun_array.push("                                                <li>","undefined"==typeof item.is_only_support_spepay_msg?"":baidu.template._encodeHTML(item.is_only_support_spepay_msg),"</li>                                            "),_template_fun_array.push("                                            "),cateStr&&_template_fun_array.push("                                                <li>仅","undefined"==typeof cateStr?"":baidu.template._encodeHTML(cateStr),"品类使用</li>                                            "),_template_fun_array.push("                                            "),shopStr&&_template_fun_array.push("                                                <li>仅","undefined"==typeof shopStr?"":baidu.template._encodeHTML(shopStr),"使用</li>                                            "),_template_fun_array.push("                                        </ul>                                    </td>                                </tr>                            </table>                            <i></i>                        </li>                    ")}_template_fun_array.push('                </ul>            </div>            <div class="bottom-div">                <span class="cbtn" data-node="closeDialog">取消</span>                <span class="btn" data-node="confirmCoupon">确定</span>            </div>            <input type="hidden" name="couponSelect" value="',"undefined"==typeof selectId?"":baidu.template._encodeHTML(selectId),'" data-idx="0" />        ')}else _template_fun_array.push('            <ul class="coupon-list">                <li class="coupon-item-empty">                  <p>没有代金券可以选择</p>                   <p>                    <span class="btn" data-node="closeDialog">返回</span>                  </p>                 </li>            </ul>        ');_template_fun_array.push('    </div>    <div data-node="tabNew" style="display:none;">        <div class="coupon-div ">            <div class="item-verify">                <input type="text" name="coupon_password" placeholder="请输入代金券密码" data-node="coupon-input">                <button data-node="coupon-check" name="verify_btn">验证</button>            </div>            <span></span>             <div data-node="newCoupons">             </div>        </div>        <div class="bottom-div" data-node="verifyBtnCon" style="display:none;">            <span class="cbtn" data-node="closeDialog">取消</span>            <span class="btn" data-node="confirmVerify">确定</span>        </div>        <input type="hidden" name="couponSelect" value="',"undefined"==typeof selectId?"":baidu.template._encodeHTML(selectId),'" data-idx="0" />    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],disItemTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<tr class="item" data-node="premiumTr">    <td class="item-name" colspan="2">        '),is_show_desc&&_template_fun_array.push("            ","undefined"==typeof desc?"":baidu.template._encodeHTML(desc),'            <em class="',"undefined"==typeof type?"":baidu.template._encodeHTML(type),'-min-icon premium-icon"><img src="https://static.waimai.baidu.com/static/forpc/',"undefined"==typeof type?"":baidu.template._encodeHTML(type),'_s.png" /></em>        '),_template_fun_array.push('    </td>    <td class="item-count">        '),is_show_amount&&_template_fun_array.push("            ","undefined"==typeof amount?"":baidu.template._encodeHTML(amount),"        "),_template_fun_array.push('    </td>    <td class="item-price-all">        '),is_show_discount&&_template_fun_array.push("             - &#165;<span>","undefined"==typeof discount?"":baidu.template._encodeHTML(discount),"</span>        "),_template_fun_array.push("     </td>    <td></td></tr>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],lefttmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<tr data-value="10" class="pay-box useLeft '),data.current_pay_plat>=10&&_template_fun_array.push("select"),_template_fun_array.push('" data-node="'),_template_fun_array.push(1===data.all_left?"payBox":"useLeft"),_template_fun_array.push('">    '),1===data.all_left?_template_fun_array.push('    <td class="radio-con">        <div class="s-radio">            <i></i>        </div>    </td>    '):(_template_fun_array.push('    <td>    <span class="checkbox '),data.current_pay_plat>=10&&_template_fun_array.push("sec"),_template_fun_array.push('"></span>    </td>    ')),_template_fun_array.push('    <td class="text">        <span class="pay-name">账户余额（可用余额<b>￥</b><span data-node="need-left-pay-amount">',"undefined"==typeof data.left_amount?"":baidu.template._encodeHTML(data.left_amount),'</span>）</span>        <span class="pay-desc">'),1===data.all_left?_template_fun_array.push("","undefined"==typeof data.left_pay_prompt?"":baidu.template._encodeHTML(data.left_pay_prompt),""):(_template_fun_array.push('<span class="need-other-pay-amount '),data.current_pay_plat<10&&_template_fun_array.push("hide"),_template_fun_array.push('">还需在线支付<b>￥',"undefined"==typeof data.need_other_pay_amount?"":baidu.template._encodeHTML(data.need_other_pay_amount),"</b></span>")),_template_fun_array.push("</span>    </td></tr>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],$addrPanel=$("[data-node=addrPanel]"),$payMethodCover=$("[data-node=payMethodCover]"),VERIFIY_AJAX="/waimai/newjudgecode",pay_plat=$("#pay_plat").val(),recall_info_lat=$("#recall_info_lat").val(),recall_info_lng=$("#recall_info_lng").val(),recall_info_address=$("#recall_info_address").val(),coupons=[],currCoupons={},total_order_price=0,orig_send_price=0,couponsDialog,cartTimeout,no_discount_flag;module.exports=Widget.extend({el:"#commit_cart",events:{"click [data-node=verifyLink]":"_verifyLink","click [name=use_coupon]":"_useCoupon","click [name=verify_btn]":"_verifyCoupon","click [data-node=userOther]":"_useOtherCoupon"},channels:{"commit.cart initCart":"initCart","commit.cart setPayPlat":"setPayPlat","commit.cart setAddress":"setAddress","commit.cart discountFlag":"setNoDiscountFlag"},initCart:function(e,t){var a=this;a._initVariable(),0==t.length?a._clearCart():(a._initCartItem(t),a._getFee("loop"))},_initVariable:function(){var e=this;e.$coupon=e.$el.find("#item-coupon"),e.$cart=e.$dom.cart,e.$discountMsg=e.$dom.discountMsg,e.$boxPrice=e.$dom.boxPrice},setNoDiscountFlag:function(e,t){no_discount_flag=t},setPayPlat:function(e,t){var a=this;pay_plat=t,a._getFee("loop")},setAddress:function(){var e=this;e._getFee("loop")},_clearCart:function(){var e=this;e.$el.find(".cart-panel").hide(),e.$el.find(".cart-empty").show(),e.$el.find(".item-list").find(".item").remove()},_verifyLink:function(){verifyphone.bindPhoneWidget()},_initCartItem:function(e){var t=this;$.each(e,function(e,a){var r="",i=[];!a.itemDishType||2!=a.itemDishType&&"attr"!=a.itemDishType||(r="special-dish"),i.push('<tr class="item '+r+'" data-stockId="'+a.itemStockId+'"  id="cartItem_'+a.itemId+'">','<td class="item-name">'+util.encodeHTML(a.itemName)+"</td>",'<td class="item-price">&#165;'+a.itemPrice+"</td>",'<td class="item-count">','<input type="hidden" value="'+a.itemId+'" />','<span class="item-count">'+a.itemCount+"</span>","</td>",'<td class="item-price-all">&#165;'+(a.itemPrice*a.itemCount).toFixed(2)+"</td>",'<td class="item-takeplace"></td>',"</tr>"),r&&(i.push('<tr class="set-item" data-id="cartItem_'+a.itemId+'">','<td colspan="5" class="setmeal-detail">'),i.push(2==a.itemDishType?t._seriSelectSetmeal(a.itemId):t._seriSelectMutiple(a.itemId)),i.push("</td></tr>")),t.$el.find(".item-list").append(i.join(""))})},_seriSelectSetmeal:function(e){var t="",a=localStore.get("s"+e+"s");for(var r in a.data){var i=a.data[r];for(var n in i)"total"!=n&&i[n].count&&(t+=i[n].dname,i[n].featueNames&&i[n].featueNames.length&&(t+="_"+i[n].featueNames.join("_")),t+="*"+i[n].count+"<br/>")}return t},_seriSelectMutiple:function(e){var t="",a=localStore.get("s"+e+"s");for(var r in a.select){var i=a.select[r];t+=i.value,t+="<br/>"}return t},_getFee:function(e){var t=this,a=t._getOrderDetail(),r=e;$payMethodCover&&$payMethodCover.removeClass("hide");try{$.ajax({url:a.query,type:"POST",data:a.post,dataType:"json",success:function(e){if(0===e.error_no){var a=e.result,i=a.order_info,n=a.discount_info,o=a.left_pay_info;if(listener.trigger("commit.delivery","discountFlag",a.xin_discount_flag),a.is_support_pay){var d=a.pay_info.pay_plat_list;t._handlePayPlat(d)}orig_send_price=i.orig_send_price,total_order_price=i.total_order_price,$.proxy(t._handleOrderInfo(i),t),$.proxy(t._handleDiscount(n.discount_list,i),t),$.proxy(t._handleCouponMsg(a.conflict_msg),t),r&&"loop"==r&&$.proxy(t._handleCoupon(a),t),o&&o.id&&$.proxy(t._changeLeftStatus(o),t),a&&a.user_info.user_mobile||!i.save_price&&!a.coupon_info.length||($("#activityTip").show(),listener.trigger("commit.delivery","initBindPhone",{flag:1})),i.total_price&&"0"!=i.total_price||addNStat({da_src:"getFeeBk.tp_zero",da_act:"callback"})}else addNStat({da_src:"getFeeBk.error",da_act:"callback"});$payMethodCover&&$payMethodCover.addClass("hide")},error:function(){$payMethodCover&&$payMethodCover.addClass("hide"),addNStat({da_src:"getFeeBk.netError",da_act:"callback"})}})}catch(i){"undefined"!=typeof alog&&alog("exception.fire","catch",{msg:i.message||i.description,path:"waimai:widget/commit/cart/cart.js",ln:230})}},_getOrderDetail:function(){var e,t=this,a=[],r="",i="",n="";if($.each(cartDC.getCarItems(),function(e,t){var r=t.itemId,i=t.itemCount,n=t.dishactflag,o=t.activitynum,d=localStore.get("s"+r+"s")||JSON.parse(cookie.get("s"+r+"s"));if(r&&i){var s;if(d){var p=$.extend({},d);s=p.basic&&p.basic.id?cartDC.adaptSetMealForServer(r,i,p):cartDC.adaptFeatureForServer(r,i,p)}else s={product_id:r,product_quantity:i};$.extend(s,{dish_activity:n||0,activity_num:o||0}),a.push(s)}}),t.$coupon){try{e=t.$coupon.find("[name=use_coupon]").hasClass("sec")}catch(o){}e&&(r=t.$coupon.find("[name=coupon_id]").val())}if($addrPanel){var d=$addrPanel.find(".addr-item");if(0!=d.length){var s=d.filter(".select");if(0!=s.length){var p=s.eq(0);i=p.find(".phone").html(),n=p.attr("data-id")}}}return{query:[["/waimai?qt","confirmorder"].join("="),["display","json"].join("="),["from","pc"].join("="),["api_level","1"].join("="),["shop_id",util.getQuery().shop_id].join("=")].join("&"),post:[["products",JSON.stringify(a)].join("="),["coupon_id",r].join("="),["pay_plat",pay_plat].join("="),["receiver_phone",i].join("="),["address_id",n].join("="),["address",recall_info_address].join("="),["lat",recall_info_lat].join("="),["lng",recall_info_lng].join("="),["no_discount_flag",no_discount_flag].join("=")].join("&")}},_handlePayPlat:function(e){for(var t=0;t<e.length;t++)$(".pay-box").filter("[data-value="+e[t].type+"]").find(".pay-desc").text(e[t].pc_desc.replace("常年返现1%起，最高免单","【官方推荐支付方式】"))},_handleOrderInfo:function(e){var t=this,a="本单已优惠 &#165; ";t.$el.find("#sendFee").html(e.orig_send_price),t.$el.find("#packFee").html(e.box_price),t.$cart.find("[data-node=sendPrice]").show(),parseFloat(e.total_discount_price)?t.$discountMsg.html(a+e.total_discount_price).show():t.$discountMsg.html("").hide(),parseFloat(e.box_price)?t.$boxPrice.show():t.$boxPrice.hide(),t.$el.find("#total_money").html(e.total_price)},_handleDiscount:function(e){var t=this,a=t.$cart.find("[data-node=discountNode]"),r=t.$cart.find("[data-node=premiumTr]"),i="";if(r.length&&r.remove(),e&&e.length){for(var n=0,o=e.length;o>n;n++){var d=e[n];(d.is_show_desc||d.is_show_discount||d.is_show_amount)&&(i+=disItemTpl(e[n]))}a.after(i)}},_handleCouponMsg:function(e){var t=this;t.$coupon.attr("data-conflict-text",e)},_handleCoupon:function(e){coupons=e.coupon_info||[];var t=this,a=e.coupon_available,r=e.coupon_selected.id?e.coupon_selected:{};0==a?(t.$coupon.hide(),$.proxy(t._setCurrCoupon({},!1,!1),t)):1==a?(t.$coupon.show(),$.proxy(t._setCurrCoupon(r,!0,!0),t)):2==a?(t.$coupon.show(),$.proxy(t._setCurrCoupon(r,!1,!0),t)):3==a&&(t.$coupon.show(),$.proxy(t._setCurrCoupon({},!1,!1),t))},_setCurrCoupon:function(e,t,a){var r=this;currCoupons=e,!currCoupons.id&&(currCoupons.id="");var i=r.$coupon.attr("data-conflict-text"),n=1,o=r.$coupon.find("[name=coupon_id]").val(),d=currCoupons.id;o==d&&1!=a&&(n=0),r.$coupon.html(couponsTpl({data:currCoupons,dselected:t,dshow:a,conflict_msg:i})),n&&r._getFee()},_changeLeftStatus:function(e){var t=!1;$(".useLeft").remove(),10==e.current_pay_plat&&1==e.all_left&&$("[data-node=payBox]").removeClass("select"),10==e.current_pay_plat&&0==e.all_left&&1==t,listener.trigger("commit.delivery","setSubmitStatus",t),$(".payList-online").find(".pay-list").prepend(lefttmpl({data:e}))},_useCoupon:function(){var e=this;return"1"==e.$coupon.attr("data-need-verify")?(verifyphone.bindPhoneWidget(),!1):void e._doUseCouponClick()},_verifyCoupon:function(){var e=this,t=e.$coupon.find("[name=coupon_password]").val();$.ajax({url:VERIFIY_AJAX,type:"GET",dataType:"json",data:{code:t,shop_id:util.getQuery().shop_id,order_price:total_order_price-orig_send_price,pay_plat:pay_plat,from:"pc"},success:function(t){if(0==t.error_no){GlobalTips.tip("您的代金券已验证成功");var a=t.result,r=a.used_coupon;coupons=a.data,0==r.is_available?GlobalTips.tip(r.exception_reason||"代金券不可用"):$.proxy(e._setCurrCoupon(r,!0,!0),e)}else GlobalTips.tip(t.error_msg||"您的代金券验证失败")}})},_useOtherCoupon:function(){var e=this,t=couponsDialogTpl({data:coupons,selectId:currCoupons.id});if(couponsDialog){var a=couponsDialog.getElement();a.html(t)}else{couponsDialog=new Dialog({html:t});var a=couponsDialog.getElement();a.on("click",function(e){e.stopPropagation()}),a.on("click","[data-node=tab] li",function(){var e=$(this),t=e.data("content");a.find("[data-node=tab] li").removeClass("select"),e.addClass("select"),a.find('[data-node="tabList"]').hide(),a.find('[data-node="tabNew"]').hide(),a.find('[data-node="'+t+'"]').show()
}),a.on("click",".coupon-card",function(){var e=$(this);if(!e.hasClass("disabled")&&!e.hasClass("selected")){var t=e.data("id"),r=e.data("index");e.siblings(".selected").removeClass("selected"),e.addClass("selected"),a.find("[name='couponSelect']").val(t),a.find("[name='couponSelect']").attr("data-idx",r)}}),a.on("click","[data-node=confirmCoupon]",function(){var t=(a.find("[name='couponSelect']").val(),a.find("[name='couponSelect']").data("idx"));$.proxy(e._setCurrCoupon(coupons[t],!0,!0),e),couponsDialog.hide({fade:!0})}),a.delegate("[name=verify_btn]","click",function(){var t=a.find('[data-node="tabNew"]'),r=t.find("[name=coupon_password]").val(),i=t.find("[data-node=verifyBtnCon]");$.ajax({url:VERIFIY_AJAX,type:"GET",dataType:"json",data:{code:r,shop_id:util.getQuery().shop_id,order_price:total_order_price-orig_send_price,pay_plat:pay_plat,from:"pc"},success:function(t){if(0==t.error_no){GlobalTips.tip("您的代金券已验证成功");var r=t.result,n=r.used_coupon;coupons=r.data,a.find('[data-node="newCoupons"]').html(couponsVeryTpl({data:n})),i.show(),i.click('[data-node="confirmVerify"]',function(){0==n.is_available?GlobalTips.tip(n.exception_reason||"代金券不可用"):($.proxy(e._setCurrCoupon(n,!0,!0),e),couponsDialog.hide({fade:!0}))})}else GlobalTips.tip(t.error_msg||"您的代金券验证失败")}})}),a.on("click","[data-node=closeDialog]",function(){couponsDialog.hide({fade:!0})}),a.parent().on("click",function(){couponsDialog.hide({fade:!0})})}couponsDialog.show({fade:!0})},_doUseCouponClick:function(){var e=this,t=e.$coupon.find("[name=use_coupon]"),a=e.$coupon.find(".coupon-area");t.hasClass("sec")?a.slideUp(300):a.slideDown(300),t.toggleClass("sec"),clearTimeout(cartTimeout),cartTimeout=setTimeout(function(){$.proxy(e._getFee(""),e)},200)}})});
;/*!waimai:widget/commit/delivery/delivery.js*/
define("waimai:widget/commit/delivery/delivery",function(require,exports,module){function setRemainTime(){0==ivrCount?(ivrCount=60,$('[data-node="getIvr"]').css("background","#ff2d4b"),$('[data-node="getIvr"]').text("重新获取"),$("#ivr-desc-caller").css("display","none"),$(".ivr-desc.error").css("display","none"),$(".ivr-desc.empty").css("display","block"),$('[data-node="submitIvr"]').addClass("disabled"),$('[data-node="getIvr"]').attr("id","getIvr"),$('[data-node="submitIvr"]').attr("id","#")):(ivrCount--,$('[data-node="submitIvr"]').removeClass("disabled"),$('[data-node="getIvr"]').attr("id","#"),$('[data-node="submitIvr"]').attr("id","submitIvr"),$('[data-node="getIvr"]').text("重新获取("+ivrCount+")"),$('[data-node="getIvr"]').css("background","#ccc"),ivrTimeout=setTimeout(function(){setRemainTime()},1e3))}function xssReg(e){var t=new RegExp("[`~!@#$^&*=|{}':;'\\[\\]<>?~！@#￥……&*——|{}【】‘；：”“'。？]"),a="";e=e||"";for(var i=0;i<e.length;i++)a+=e.substr(i,1).replace(t,"");return a}function ajax(e,t,a,i,r){try{$.ajax({url:e,type:"post",dataType:"json",data:t,cache:!1,success:function(e){a(e)},error:i||function(){GlobalTips.tip("抱歉，服务出错")},complete:r||function(){}})}catch(d){"undefined"!=typeof alog&&alog("exception.fire","catch",{msg:d.message||d.description,path:"waimai:widget/commit/delivery/delivery.js",ln:473})}}function sendGa(e){var t=e.result,a=12,i=cartDC.getCarItems();ga("require","ecommerce","ecommerce.js"),ga("ecommerce:addTransaction",{id:t.order_id||a,affiliation:cartDC.getCurShopName(),revenue:$("#total_money").html(),shipping:"",tax:"",currency:"CNY"});for(var r=0,d=i.length;d>r;r++)ga("ecommerce:addItem",{id:t.order_id||a++,name:i[r].itemName+"_"+i[r].itemId,sku:"",category:"",price:i[r].itemPrice,quantity:i[r].itemCount});ga("ecommerce:send")}function initRefInfo(e){var t={};t.lng=e.lng||"",t.lat=e.lat||"",t.address=e.address||"",cofirmRefInfo=t}function initShopInfo(e){cofirmCurrDel=e.curr_delivery_time}var cartDC=require("waimai:static/utils/CartDataCenter"),GlobalTips=require("waimai:static/utils/GlobalTips"),verifyphone=require("waimai:widget/common/verifyphone/verifyphone"),callback=require("waimai:widget/commit/callback/callback"),userAddress=require("waimai:widget/common/ui/address/address"),addressEditDialog=require("waimai:widget/common/ui/addressEditDialog/addressEditDialog"),superTip=require("waimai:static/utils/superTip"),cookie=require("wcommon:static/util/Cookie"),localStore=require("waimai:static/utils/store"),DropDown=require("jsmod/ui/fixElement/dropDown"),JSelect=require("jsmod/ui/fixElement/dropDown/select"),Dialog=require("jsmod/ui/dialog"),currDelTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="curr_del"><p class="oc-desc">由于配送人员繁忙预计',"undefined"==typeof data?"":baidu.template._encodeHTML(data),'送达</p><p class="oc-desc">是否继续下单？</p><div class="submitBtns"><a class="oc-btn continueBook" href="javascript:;" nstat="click|{da_src:develieryBk.goOn}">继续下单</a><a class="oc-btn-dis" nstat="click|{da_src:develieryBk.goUrl}" href="http://waimai.baidu.com/">再去逛逛</a></div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],leftcheckTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="dialog-limit" data-node="dialog-limit"><p class="title">今日账户余额支付超过累计支付额度，请进行验证</p><div class="info"><span>已绑定手机</span><span class="phone_num">',"undefined"==typeof phonenum?"":baidu.template._encodeHTML(phonenum),'</span><input value="',"undefined"==typeof(0==countDown?"发送动态码":0/0+countDown+"s）")?"":baidu.template._encodeHTML(0==countDown?"发送动态码":0/0+countDown+"s）"),'" type="button" class="send_code" data-node="send_code" /></div><div class="label-input"><label>验证码</label><input data-node="code" /></div><p class="error_msg" data-node="error_msg"></p><div class="btn"><input value="确定" type="button" class="confirm" data-node="confirm" /><input value="取消" type="button" class="cancel" data-node="cancel" /></div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],ivrTpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="ivr_del">    <div class="ivr-close"></div>    <p class="ivr-desc">为了保证送餐员能及时联系到您</p>    <p class="ivr-desc">请验证您的送餐手机号（电话语音验证）:&nbsp;&nbsp;&nbsp;&nbsp;<a style="font-size: 18px">',"undefined"==typeof data.result.user_phone?"":baidu.template._encodeHTML(data.result.user_phone),'</a></p>    <div class="submitBtns">        <input class="ivr-input" id=""/>        <a class="oc-btn" data-node="getIvr" id="getIvr">获取语音验证</a>    </div>    <p class="ivr-desc caller" id="ivr-desc-caller">来自<span style="color: red">&nbsp;',"undefined"==typeof data.result.caller_phone?"":baidu.template._encodeHTML(data.result.caller_phone),'&nbsp;</span>的电话，将为您播报语音验证码</p>    <p class="ivr-desc empty" >&nbsp;</p>    <p class="ivr-desc error"><span style="color: red"></span></p>    <div class="submitBtns">        <a class="oc-btn disabled" id="submitIvr" data-node="submitIvr" href="javascript:;">确定</a>        <a id="" class="ignore" href="javascript:;">跳过，使用原价支付</a>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],url_commitOrder="/waimai?qt=book",url_getIvr="/trade/ivrcode",userAddrList=[],defaultMark="例如：口味要求，送达时间",curUserAddr,cofirmRefInfo,cofirmCurrDel,isCanSubmit=!1,recall_address_check=1,leftDialog=null,needVerifyPhone=!1,ADDR_CHECKED=1,hotdishFlag=0,searchdishFlag=0,ivrCount=60,phonenum="",ivrcode="",left_count_down_flag,ivrTimeout,ivrDialog,superTipObj,no_discount_flag,xindiscountFlag;module.exports=Widget.extend({el:"#delivery",events:{"click [data-node=addrPanel] li[data-id]":"_setCurAddrPanel","click [data-node=expPanel]":"_showExpPanel","click [data-node=continueToBook]":"_continueToBook","click [data-node=payMethod] [data-node=payBox]":"_changePayMethod","click [data-node=useLeft]":"_useLeftPay","click #orderSubmit":"_orederSubmit"},channels:{"commit.delivery initBindPhone":"initBindPhone","commit.delivery setSubmitStatus":"setSubmitStatus","commit.delivery setZhuShiTip":"setZhuShiTip","commit.delivery discountFlag":"setDiscountFlag"},init:function(e){var t=this,a=[];hotdishFlag=e.hotdish_flag,phonenum=e.user_mobile,searchdishFlag=util.getQuery().searchdishid?1:0,t._initVariable(),1==hotdishFlag&&addNStat({da_src:"hotdishconfirmBk",da_act:"click",da_trd:"waimai"}),1==searchdishFlag&&addNStat({da_src:"searchdishconfirmBk",da_act:"click",da_trd:"waimai"}),e.address&&e.address.length>0&&$.each(e.address,function(e,i){a.push(t._addrServerToClient(i))}),userAddrList=t._addrAdjust(a||[]),t._getCurUserAddr(),t.$el.find("#continue-to-book").hide(),t._showUserAddrList(),t._initdeliverySelect(e.send_time),t._initMark(),initRefInfo(e.recall_info),initShopInfo(e.shop_info)},_initVariable:function(){var e=this;e.$continueToBook=e.$dom.continueToBook,e.$orderSubmit=e.$el.find("#orderSubmit"),e.$expPanel=e.$dom.expPanel,e.$addrPanel=e.$dom.addrPanel,e.$listBottom=e.$dom.listBottom,e.$listTitle=e.$dom.listTitle,e.$payMethod=e.$dom.payMethod,e.$payListOffline=e.$dom.payListOffline,e.$addNew=e.$dom.addNew,e.$leftCheckVercode=e.$el.find("[data-node=left-check-vercode]"),e.$leftCheckCountDown=e.$el.find("[data-node=left-check-count-down]"),e.$markInput=e.$dom.markInput,e.$markInputList=e.$el.find("[data-node=markInput_list]"),e.$needLeftPayAmount=e.$el.find("[data-node=need-left-pay-amount]")},setDiscountFlag:function(e,t){xindiscountFlag=t},initBindPhone:function(e,t){needVerifyPhone=t.flag},setSubmitStatus:function(e,t){var a=this;a._changeBtn_submitOrderStatus(t)},setZhuShiTip:function(){var e=cartDC.getCarItems(),t=/饭|面|米线|米粉|汉堡|饼|年糕|粥|饺子|肉夹馍|面皮|三明治|披萨|花卷|馄饨|套餐|比萨|馒头|便当/,a=!1,i=$(".warning-tips");for(var r in e)if(e[r]&&t.test(e[r].itemName)){a=!0;break}a?i.hide():i.show()},_initdeliverySelect:function(e){var t,a=this,i=e.day,r=a.$el.find("#send_time_date"),d=a.$el.find("#send_time_minute"),n=e.time,s=n[0],o=a._initSelect(i,"#send_time_date"),l=a._initSelect(s,"#send_time_minute");a.$orderSubmit.isFillTime=!1,i[0]&&r.val(i[0]).data("key",0);for(var c in s){t={key:c,value:s[c]};break}1==t.key&&(d.val(t.value).data("key",t.key),a.$orderSubmit.isFillTime=!0),a._changeBtn_submitOrderStatus(!1),o.onselectitem=function(e,i){r.data("key",i.key),s=n[i.key],l&&l.destroy(),l=a._initSelect(s,"#send_time_minute"),$.proxy(a._timeBindEvent(l,d),a);for(var o in s){t={key:o,value:s[o]};break}d.val(t.value).data("key",t.key),d.data("key")&&(a.$orderSubmit.isFillTime=!0,$.proxy(a._changeBtn_submitOrderStatus(!1),a))},$.proxy(a._timeBindEvent(l,d),a),$(".arrow_date").on("click",function(){r.trigger($.Event("click"))}),$(".arrow_minute").on("click",function(){d.trigger($.Event("click"))})},_initSelect:function(e,t){var a=[];for(var i in e)e.hasOwnProperty(i)&&a.push({idx:i,val:e[i]});return new JSelect(a,{seed:t,target:t,fun:function(e,t){return{key:t.idx,value:t.val,html:'<a href="javascript: void(0)">'+t.val+"</a>"}}})},_timeBindEvent:function(e,t){var a=this;e.onselectitem=function(e,i){t.data("key",i.key),a.$orderSubmit.isFillTime=!0,$.proxy(a._changeBtn_submitOrderStatus(!1),a)}},_initMark:function(e){var t=this,a=$.parseJSON(t.$markInputList.html()||"[]"),i=[],r=e||t.$markInput;for(var d in a)a.hasOwnProperty(d)&&i.push({idx:d,val:a[d]});var n=new DropDown(i,{seed:r,target:r,className:"markStyle",keyPressShow:!1,syncInput:!1,fun:function(e,t){return{key:t.idx,value:t.val,html:'<a class="s-item" href="javascript: void(0)">'+t.val+"</a>"}}});r.focusin(function(){n._isHide&&n.show()}),i[0]?r.val(i[0].val):r.attr("placeholder","请输入特殊要求"),n.onselectitem=function(e,t){var a=r.val(),i=a?a+","+t.value:t.value;r.val(i),e.preventDropDownHide=!0,r.focus()},$(document).click(function(e){var t=$(e.target);t[0]==r[0]||t.hasClass("markStyle")||t.parents(".markStyle").length||n.hide()}),$("input.mark").on("keyup change",function(){var e=$(this),t=$.trim(e.val()),a=t.length;t!==e.val()&&e.val(t),a>72&&(e.val(t.substr(0,72)),GlobalTips.tip("备注不能超过72个字"))})},_addrServerToClient:function(e){return{id:e.id,addr:e.address,tel:e.user_phone,isDefault:1==e.status,gender:e.gender,user_name:e.user_name,sug_address:e.sug_address,detail_address:e.detail_address,location:e.location}},_addrAdjust:function(e){for(var t=0,a=e.length;a>t;t++)e[t].user_phone=e[t].user_phone||e[t].tel,e[t].address=e[t].address||e[t].addr;return e},_getCurUserAddr:function(){!curUserAddr&&userAddrList.length>0&&(curUserAddr=userAddrList[0])},_showUserAddrList:function(){var e,t=this,a={data:userAddrList,$listEl:t.$addrPanel,$detailEl:t.$addrPanel,$addBtn:t.$addNew,saveSuccess:function(e,a){e.cacheDialog&&e.cacheDialog.hide({fade:!0}),"update"==a.__type?(t._updateUserAddrList(a),e.opt.data=userAddrList):"add"==a.__type&&(t._appendNewAddr(a),e.opt.data=userAddrList,t._setCurUserAddr(a.id)),e.opt.$listEl.html(""),e.initList(),e.successTip("保存成功！"),listener.trigger("commit.cart","setAddress")},listComplete:function(e){if(e.opt.data.length?(t.$listTitle.show(),e.opt.$listEl.find("[data-id="+curUserAddr.id+"]").addClass("select")):(e.opt.$listEl.html(e.addFormHtml()),e.opt.$listEl.find(".placeholder-con").placeholder(),e.bindGenderEvent(e.opt.$listEl),t.$listTitle.hide()),!t.$expPanel.clicked&&e.opt.data.length>2){t.$listBottom.show();var a=e.opt.$listEl.find("li").outerHeight(),i=parseInt(e.opt.$listEl.find("li").css("marginBottom"),10)||0,r=parseInt(e.opt.$listEl.find("li").css("marginTop"),10)||0;e.opt.$listEl.height(a+i+r)}else t.$listBottom.hide(),e.opt.$listEl.height("auto");t._checkSugAddress(),$.proxy(t._changeBtn_submitOrderStatus(!1),t)},itemRemove:function(e,a){e.opt.data=$.map(e.opt.data,function(e){return e.id!=a?e:null}),userAddrList=e.opt.data,a==curUserAddr.id&&(curUserAddr=null,t._getCurUserAddr(),curUserAddr&&e.opt.$listEl.find("[data-id="+curUserAddr.id+"]").addClass("select")),e.opt.data.length?e.opt.data.length<=2&&t.$listBottom.hide():(t.$listTitle.hide(),e.opt.$listEl.html(e.addFormHtml()),e.opt.$listEl.css("height","auto"),e.bindGenderEvent(e.opt.$listEl),e.opt.$listEl.find(".placeholder-con").placeholder(),e.initSugEvent($(".delivery-ul .new-address-section"))),$.proxy(t._changeBtn_submitOrderStatus(!1),t),listener.trigger("commit.cart","setAddress")},dialogShow:function(e){e.opt.$detailEl&&(e.opt.$detailEl.on("click",".saveBtn",function(){e.saveAddress()}),e.opt.$detailEl.on("click",".escBtn",function(){e.cacheDialog.hide({fade:!0})}),e.opt.$detailEl.find(".placeholder-con").placeholder())}};e=new userAddress(a),t.$el.find(".addr-list-li").show().find("[data-node=loading]").hide()},_updateUserAddrList:function(e){e.tel=e.user_phone||e.tel,e.addr=e.address||e.addr;for(var t=0,a=userAddrList.length;a>t;t++)if(userAddrList[t].id==e.id){$.extend(userAddrList[t],e);break}},_appendNewAddr:function(e){var t=$.extend({},e);t.tel=e.user_phone||e.tel,t.addr=e.address||e.addr,userAddrList.unshift(t)},_setCurUserAddr:function(e){for(var t=0,a=userAddrList.length;a>t;t++)if(userAddrList[t].id==e){curUserAddr=userAddrList[t];break}},_checkSugAddress:function(){var e=$(".addr-item.select"),t=e.data("sugaddress");if(superTipObj&&superTipObj.remove&&superTipObj.remove(),e.length&&!t){$("body").scrollTop(0),superTipObj=superTip.create({hostSelector:e,autoClose:!0,showTime:3e3,msg:"输入确切地址方便外卖小哥找到你<div style='text-align: center;'><a href='javascript:;' class='edit_cur_addr' style='color: #ff2d4b;'>去修改</a></div>",borderRadius:5,triangleColor:"#ddcc9c",position:{my:"top left",at:"top center"},offset:{x:0,y:70}},{display:"none","background-color":"rgba(254, 248, 222, 0.9)","background-color\x00":"rgb(254, 248, 222)\x00","font-size":"14px",color:"#333","line-height":"1.4","z-index":"1000",border:"solid 1px #ddcc9c",width:"250px"}),setTimeout(function(){superTipObj.show()},200);var a=superTipObj.key;$("#"+a+" .edit_cur_addr").off("click").on("click",function(){superTipObj.remove(),addressEditDialog.showDetailDialog(curUserAddr,!1,!0),addNStat({da_src:"deliveryAddSugAddressDialog",da_act:"show",da_trd:"waimai"})})}},_checkSugAddress2:function(){var e=$(".addr-item.select"),t=e.data("sugaddress");if(t)return void(isCanSubmit=!0);if(isCanSubmit=!1,curUserAddr&&curUserAddr.id){var a="dialog-s-list-myaddress-not-position",i="."+a,r=$(i);r.length||(r=$('<div class="'+a+'"><div class="dslm-container"><p>我们在地图上找不到您的位置<br />为了更好的为您服务，求告知～</p><p><input type="button" class="dslm-go-set-btn" value="去添加" /></p></div></div>').appendTo("body")),r.show().undelegate(".dslm-go-set-btn","click").delegate(".dslm-go-set-btn","click",function(){r.hide(),addressEditDialog.showDetailDialog(curUserAddr,!1,!0),addNStat({da_src:"deliveryAddSugAddressDialog",da_act:"show",da_trd:"waimai"})})}},_changeBtn_submitOrderStatus:function(e){var t=this,a=t.$el.find("#commit_warning"),i=t.$orderSubmit.closest("div").show();cartDC.isEmpty()||!curUserAddr?(t.$continueToBook.hide(),i.removeClass("delivery-btn").addClass("delivery-btn-no").find("h2").html("确认下单"),isCanSubmit=!1):cartDC.getAmount().cha>0?(GlobalTips.tip("未到起送价，请返回菜单重新选择"),i.removeClass("delivery-btn").addClass("delivery-btn-no").find("h2").html("未到起送价"),t.$continueToBook.show(),isCanSubmit=!1):t.$orderSubmit.isCommiting?(i.removeClass("delivery-btn").addClass("delivery-btn-no").find("h2").html("正在下单"),isCanSubmit=!1):t.$orderSubmit.isFillTime?e?(i.removeClass("delivery-btn").addClass("delivery-btn-no").find("h2").html("支付方式有误"),isCanSubmit=!1):(t.$continueToBook.hide(),i.removeClass("delivery-btn-no").addClass("delivery-btn").find("h2").html("确认下单"),isCanSubmit=!0):(i.removeClass("delivery-btn").addClass("delivery-btn-no").find("h2").html("未填写送达时间"),isCanSubmit=!1),curUserAddr?a.hide():a.show()},_setCurAddrPanel:function(e){var t=this,a=$(e.currentTarget),i=a.attr("data-id");no_discount_flag=0,listener.trigger("commit.cart","discountFlag",no_discount_flag),t.$addrPanel.find("li[data-id]").removeClass("select"),a.addClass("select"),t._setCurUserAddr(i),listener.trigger("commit.cart","setAddress"),t._checkSugAddress()},_showExpPanel:function(){var e=this,t=e.$addrPanel.find("li").length,a=e.$addrPanel.find("li").outerHeight(),i=parseInt(e.$addrPanel.find("li").css("marginBottom"),10)||0,r=parseInt(e.$addrPanel.find("li").css("marginTop"),10)||0;height=t/2*(a+r+i)+"px",e.$addrPanel.animate({height:height},function(){e.$listBottom.hide(),e.$addrPanel.height("auto")}),e.$expPanel.clicked=!0},_continueToBook:function(e){var t=$(e.currentTarget).data("href");window.location=t},_changePayMethod:function(e){var t=this,a=$(e.currentTarget),i=a.data("value"),r=t.$el.find(".useLeft");t.$dom.payMethod.find("[data-node=payBox]").removeClass("select"),"0"==i&&r&&(r.find(".checkbox").removeClass("sec"),r.removeClass("select")),a.addClass("select"),listener.trigger("commit.cart","setPayPlat",t._getPayPlat())},_useLeftPay:function(e){var t=this,a=$(e.currentTarget),i=t.$payListOffline.find('[data-node="payBox"]'),r=a.find(".checkbox");i.removeClass("select"),r.toggleClass("sec"),a.toggleClass("select"),r.hasClass("sec")?a.find(".need-other-pay-amount").removeClass("hide"):a.find(".need-other-pay-amount").addClass("hide"),10==t._getPayPlat()&&(t._changeBtn_submitOrderStatus(!0),$("#item-coupon").hide())},_orederSubmit:function(){var e=this;if(+e._itemTotal()>999)return void GlobalTips.tip("所点菜品数量过多");e._checkSugAddress2(),1==hotdishFlag&&addNStat({da_src:"hotdishcommitBk.commitBtn",da_act:"click",da_trd:"waimai"}),1==searchdishFlag&&addNStat({da_src:"searchdishcommitBk.commitBtn",da_act:"click",da_trd:"waimai"}),addNStat({da_src:"commitBk.commitBtn",da_act:"click",da_trd:"waimai"});var t=e._getOrderDetail();if(isCanSubmit&&!e.$orderSubmit.isCommiting&&e.$orderSubmit.isFillTime){if(needVerifyPhone)return addNStat({da_src:"verifyBk.verifyOly",da_act:"show",da_trd:"waimai"}),needVerifyPhone=!1,void verifyphone.bindPhoneWidget();if("1"==t.send_time&&cofirmCurrDel&&parseInt(cofirmCurrDel)){addNStat({da_src:"develieryBk.develieryOly",da_act:"show",da_trd:"waimai"});var a=util.dateFormat(new Date(1e3*parseInt(cofirmCurrDel)),"hh:mm"),i=currDelTpl({data:a});Dialog.disableKeyEvent();var r=new Dialog({html:i}),d=r.getElement();return d.on("click",".continueBook",function(){cofirmCurrDel=0,e.$orderSubmit.trigger("click"),r.hide({fade:!1})}),void r.show({fade:!0})}e.$orderSubmit.isCommiting=!0,e._changeBtn_submitOrderStatus(!1);var n=e._getOrderDetail();$.extend(n,{recall_address_check:recall_address_check}),e._pollBook(url_commitOrder,n)}},_getPayPlat:function(){var e=this,t=0;if(e.$payMethod){var a=e.$payMethod.find(".pay-box").filter(".select");$.each(a,function(e,a){t+=1*$(a).data("value")})}return t},_itemTotal:function(){for(var e=0,t=0;t<$("input.item-count").length;t++)e+=1*$("input.item-count").eq(t).val();return e},_getOrderDetail:function(){var e,t=this,a=$.trim(xssReg(t.$el.find("#mark").val())),i=$("#item-coupon"),r="",d=t.$el.find("#invoice_title"),n=t._getPayPlat(),s=0,o=t.$leftCheckVercode.val(),l=+$("#total_money").html();if(n>10){var c=+t.$needLeftPayAmount.html();s=l>=c?c:l}else 10==n&&(s=l);a==defaultMark&&(a="");var u={total_price:l,products:[],left_pay_amount:s};if(i){try{e=i.find("[name=use_coupon]").hasClass("sec")}catch(m){}e&&(r=i.find("[name=coupon_id]").val())}$.each(cartDC.getCarItems(),function(e,t){var a=t.itemId,i=t.itemCount,r=t.dishactflag,d=t.activitynum,n=localStore.get("s"+a+"s")||JSON.parse(cookie.get("s"+a+"s"));if(a&&i){var s;if(n){var o=$.extend({},n);s=o.basic&&o.basic.id?cartDC.adaptSetMealForServer(a,i,o):cartDC.adaptFeatureForServer(a,i,o)}else s={product_id:a,product_quantity:i};$.extend(s,{dish_activity:r||0,activity_num:d||0}),u.products.push(s)}}),!u.total_price&&addNStat({da_src:"deliveryBk.tp_null",da_act:"commit",da_trd:"waimai"});var p=$("#bdstoken").val(),_=t.$el.find("#send_time_minute").data("key")||"";!curUserAddr&&(curUserAddr={});var v={user_phone:curUserAddr.tel,user_real_name:curUserAddr.user_name,user_address:curUserAddr.addr,address_id:curUserAddr.id,user_note:a,send_time:_,sex:curUserAddr.gender,from:"pc",coupon_id:r,shop_id:cartDC.getCurShopId(),content:JSON.stringify(u),pay_plat:n,address_check:ADDR_CHECKED,bdstoken:p,no_discount_flag:no_discount_flag,xin_discount_flag:xindiscountFlag,ivrcode:ivrcode};if(d.length){var f=$.trim(xssReg(d.val()));f&&(v.need_invoice=1,v.invoice_title=f)}return cofirmRefInfo&&$.extend(v,cofirmRefInfo),o&&(v.ver_code=o),v},_pollBook:function(e,t){var a=this;ajax(e,t,function(i){if(recall_address_check=1,111056==i.error_no)return ivrDialog&&ivrDialog.hide({fade:!1}),void $.proxy(a._notInScope(),a);if(111070==i.error_no)return ivrDialog&&ivrDialog.hide({fade:!1}),void $.proxy(a._addressHasInaccuracy(),a);if(119001==i.error_no)return void $.proxy(a._leftCheck(),a);if(118001==i.error_no){var r=ivrTpl({data:i});!ivrDialog&&Dialog.disableKeyEvent(),ivrDialog=null,ivrDialog=new Dialog({html:r,width:478,height:268}),$('[data-node="submitIvr"]').attr("id","#");var d=ivrDialog.getElement();return d.on("click","#getIvr",function(){$(".ivr-input").val("");var e=$(".addr-item.select").attr("data-id"),t={address_id:e};ajax(url_getIvr,t,function(e){0==e.error_no?($("#ivr-desc-caller").css("display","block"),$(".ivr-desc.empty").css("display","none"),$(".ivr-desc.error").css("display","none"),setRemainTime()):($("#ivr-desc-caller").css("display","none"),$(".ivr-desc.error").css("display","block"),$(".ivr-desc.error").find("span").text(e.error_msg))},null,function(){})}),d.on("click","#submitIvr",function(){var i=$(".ivr-input").val();""==$.trim(i)?($("#ivr-desc-caller").css("display","none"),$(".ivr-desc.empty").css("display","none"),$(".ivr-desc.error").css("display","block"),$(".ivr-input").css("border-color","red"),$(".ivr-input").val(""),$(".ivr-input").focus(),$(".ivr-desc.error").find("span").text("验证码不能为空")):(t.ivrcode=i,a._pollBook(e,t))}),d.on("keydown",".ivr-input",function(){$("#ivr-desc-caller").css("display","none"),$(".ivr-desc.empty").css("display","block"),$(".ivr-desc.error").css("display","none"),$(".ivr-input").css("border-color","#e4e4e4")}),d.on("click",".ivr-close",function(){ivrDialog.hide({fade:!1}),clearTimeout(ivrTimeout)}),d.on("click",".ignore",function(){ivrDialog.hide({fade:!1}),no_discount_flag=1,listener.trigger("commit.cart","discountFlag",no_discount_flag),listener.trigger("commit.cart","setAddress")}),clearTimeout(ivrTimeout),void ivrDialog.show()}if(i.error_no<=118500&&i.error_no>=118400){var r=ivrTpl({data:i});return ivrDialog.show(),$(".ivr-input").css("border-color","red"),$(".ivr-input").focus(),$(".ivr-desc.empty").css("display","none"),$("#ivr-desc-caller").css("display","none"),$(".ivr-desc.error").css("display","block"),void $(".ivr-desc.error").find("span").text(i.error_msg)}if(0==i.error_no&&i.result&&i.result.jump_url)return ivrDialog&&ivrDialog.hide({fade:!1}),void(window.location.href=i.result.jump_url);if(a.$orderSubmit.isCommiting=!1,i=$.extend(i,{shop_id:cartDC.getCurShopId(),phone:curUserAddr.tel}),0==i.error_no){try{sendGa(i)}catch(n){}cartDC.clearCar(!0),cartDC.clearData(i.shop_id)}callback.orderCallback(i)},null,function(){recall_address_check=1,a.$orderSubmit.isCommiting=!1,$.proxy(a._changeBtn_submitOrderStatus(),a)})},_notInScope:function(){var e=this,t="dialog-delivery-not-in-scope",a="."+t,i=$(a);i.length||(i=$('<div class="'+t+'"><div class="dslm-container"><p>“'+curUserAddr.sug_address+'”不在商户配送范围</p><p><input type="button" class="dnis-select-other-btn" value="去选择其他地址" /><input type="button" class="dnis-go-shoplist-btn" value="去逛逛“'+(curUserAddr.sug_address.length>7?curUserAddr.sug_address.substr(0,6)+"…":curUserAddr.sug_address)+'”周边的商户" /></p></div></div>').appendTo("body")),addNStat({da_src:"deliveryBk.notInScopeDialog",da_act:"show",da_trd:"waimai"}),i.show().undelegate(".dnis-select-other-btn","click").delegate(".dnis-select-other-btn","click",function(){addNStat({da_src:"deliveryBk.notInScopeDialog.selectOtherAddrBtn",da_act:"click",da_trd:"waimai"}),i.hide(),e.$expPanel.trigger("click")}).undelegate(".dnis-go-shoplist-btn","click").delegate(".dnis-go-shoplist-btn","click",function(){addNStat({da_src:"deliveryBk.notInScopeDialog.searchShopBtn",da_act:"click",da_trd:"waimai"}),i.hide(),window.Search.goShopList(curUserAddr)})},_addressHasInaccuracy:function(){var e=this,t="dialog-delivery-not-in-scope2",a="."+t,i=$(a);i.length||(i=$('<div class="'+t+'"><div class="dslm-container"><p>您的收餐地址距离'+curUserAddr.sug_address+'超过500米～</p><p><input type="button" class="dnis-go-on" value="继续下单" /><input type="button" class="dnis-cancel" value="去选择其他地址" /></p></div></div>').appendTo("body")),addNStat({da_src:"deliveryBk.addressHasInaccuracyDialog",da_act:"show",da_trd:"waimai"}),i.show().undelegate(".dnis-go-on","click").delegate(".dnis-go-on","click",function(){addNStat({da_src:"deliveryBk.addressHasInaccuracyDialog.buyGoOnBtn",da_act:"click",da_trd:"waimai"}),i.hide(),recall_address_check=0,e.$orderSubmit.trigger("click")}).undelegate(".dnis-cancel","click").delegate(".dnis-cancel","click",function(){addNStat({da_src:"deliveryBk.addressHasInaccuracyDialog.selectOhterAddrBtn",da_act:"click",da_trd:"waimai"}),i.hide(),e.$expPanel.trigger("click")})},_leftCheck:function(){var e=this;leftDialog||(Dialog.disableKeyEvent(),leftDialog=null),e.$leftCheckVercode.val("");var t=+e.$leftCheckCountDown.val();leftDialog=new Dialog({html:leftcheckTpl({countDown:t,phonenum:phonenum}),width:"auto",height:"auto"});var a=leftDialog.getElement(),i=a.find("[data-node=error_msg]");0!=t&&(clearInterval(left_count_down_flag),left_count_down_flag=setInterval(function(){$.proxy(e._countDown(a),e)},1e3)),a.on("click",function(e){e.stopPropagation()}),a.on("keypress","[data-node=code]",function(){i.html("")}),a.on("click","[data-node=confirm]",function(){var t=/^[0-9]*$/,r=$.trim(a.find("[data-node=code]").val());t.test(r)&&r?(e.$leftCheckVercode.val(r),leftDialog.hide(),setTimeout(function(){e.$orderSubmit.trigger("click")},200)):i.html("验证码不正确")}),a.on("click","[data-node=cancel]",function(){leftDialog.hide()}),a.on("click","[data-node=send_code]",function(){var t=+e.$leftCheckCountDown.val();0==t&&(a.find("[data-node=code]").val(""),$.ajax({url:"/pay?qt=sendvercode&type=pay",dataType:"json",type:"GET",success:function(t){0==t.error_no?(i.html("发送成功"),e.$leftCheckCountDown.val(60),left_count_down_flag=setInterval(function(){$.proxy(e._countDown(a),e)},1e3)):i.html(t.error_msg)}}))}),leftDialog.show()},_countDown:function(e){var t=this,a=+t.$leftCheckCountDown.val(),i=e.find("[data-node=send_code]");a>0?(--a,i.val("重新获取（"+a+"s）"),t.$leftCheckCountDown.val(a)):(i.val("发送动态码"),clearInterval(left_count_down_flag))}})});
;/*!waimai:page/commit.js*/
define("waimai:page/commit",function(i,t,e){var a=i("waimai:static/utils/CartDataCenter"),r=i("waimai:widget/commit/callback/callback"),s=i("waimai:static/utils/GlobalTips");$(a).bind("inited.shopCar",function(i,t){t.shopItem.length<=0&&setTimeout(function(){s.tip("购物车为空？可能是浏览器导致，换个浏览器试试吧~")},500),listener.trigger("commit.cart","initCart",t.shopItem),listener.trigger("commit.delivery","setSubmitStatus",!1),listener.trigger("commit.delivery","setZhuShiTip")}),e.exports={init:function(i,t){a.init(i),t.antispam.is_cheat_user&&setTimeout(function(){r.orderCallback({error_msg:t.antispam.cheat_msg,error_type:"blacklist"})},500)}}});