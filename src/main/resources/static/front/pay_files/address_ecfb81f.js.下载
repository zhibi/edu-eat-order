define("waimai:widget/common/ui/address/address",function(require,exports,module){function Address(e){this.opt=$.extend({},_opt,e),this.bindEvent(),this.initList()}var Dialog=require("jsmod/ui/dialog"),listTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push("");for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('<li class="addr-item" data-id="',"undefined"==typeof item.id?"":baidu.template._encodeHTML(item.id),'" data-sugaddress="',"undefined"==typeof item.sug_address?"":baidu.template._encodeHTML(item.sug_address),'" data-msg="',"undefined"==typeof item.user_name?"":baidu.template._encodeHTML(item.user_name),"$","undefined"==typeof item.gender?"":baidu.template._encodeHTML(item.gender),"$","undefined"==typeof item.user_phone?"":baidu.template._encodeHTML(item.user_phone),"$","undefined"==typeof item.sug_address?"":baidu.template._encodeHTML(item.sug_address),"$","undefined"==typeof item.detail_address?"":baidu.template._encodeHTML(item.detail_address),"$","undefined"==typeof item.location?"":baidu.template._encodeHTML(item.location),"$","undefined"==typeof item.uid?"":baidu.template._encodeHTML(item.uid),'">    <div class="addr-title">        <div class="addr-user">            <span class="name">',"undefined"==typeof item.user_name?"":baidu.template._encodeHTML(item.user_name),'</span>            <span class="sex">',"undefined"==typeof(2==item.gender?"女士":"先生")?"":baidu.template._encodeHTML(2==item.gender?"女士":"先生"),'</span>        </div>        <div class="addr-action">            <a class="addr-edit">编辑</a>            <a class="addr-remove">删除</a>        </div>    </div>    <div class="addr-con">        <p class="phone">',"undefined"==typeof item.user_phone?"":baidu.template._encodeHTML(item.user_phone),'</p>        <p class="addr-desc">',"undefined"==typeof item.address?"":baidu.template._encodeHTML(item.address),'</p>    </div>    <span class="select-ico"></span></li>')}_template_fun_array.push(""),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],detailTeml=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="addr-detail new-address-section">    <form>        <table class="addr-table" border="0">            <tr>                <td valign="top"><span class="l-label">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</span></td>                <td>                    <input type="hidden" value="',"undefined"==typeof data.id?"":baidu.template._encodeHTML(data.id),'" name="adrr_id">                    <div class="form-group">                        <div class="input-control">                            <input type="text" name="user_name" placeholder="您的姓名" value="',"undefined"==typeof data.user_name?"":baidu.template._encodeHTML(data.user_name),'" class="placeholder-con">                            <span class="star">*</span>                        </div>                        <div class="error-msg v-hide">请填写您的姓名，不能超过8个字符</div>                    </div>                    <div class="form-group">                        <div class="input-control">                                                        <input type="hidden" name="gender" value="',"undefined"==typeof(data.gender?data.gender:1)?"":baidu.template._encodeHTML(data.gender?data.gender:1),'">                            <div class="s-gender '),(1===parseInt(data.gender,10)||isNaN(parseInt(data.gender,10)))&&_template_fun_array.push(" selected "),_template_fun_array.push('" data-gender="1"  >                                <i></i><span>先生</span>                            </div>                            <div class="s-gender '),2==data.gender&&_template_fun_array.push(" selected "),_template_fun_array.push('" data-gender="2">                                <i></i><span>女士</span>                            </div>                        </div>                        <div class="error-msg v-hide">请选择您的性别</div>                    </div>                </td>            </tr>            <tr>                <td valign="top"><span class="l-label">电&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;话</span></td>                <td>                    <div class="form-group">                        <div class="input-control">                            <input type="text" name="user_phone" placeholder="11位手机号" value="',"undefined"==typeof data.user_phone?"":baidu.template._encodeHTML(data.user_phone),'" class="placeholder-con">                            <span class="star">*</span>                        </div>                        <div class="error-msg v-hide">请填写正确的手机号</div>                    </div>                </td>            </tr>            <tr>                <td valign="top"><span class="l-label">位&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;置</span></td>                <td>                    <div class="form-group">                        <div class="input-control poi_address">                            <i class="addr-icon-input"></i>                            <input type="text" name="sug_address" placeholder="请输入小区、大厦或学校" value="',"undefined"==typeof data.sug_address?"":baidu.template._encodeHTML(data.sug_address),'" class="placeholder-con poi_address">                            <span class="star">*</span>                                                        <input type="hidden" name="hide_sug_address" value="',"undefined"==typeof data.lng?"":baidu.template._encodeHTML(data.lng),"-","undefined"==typeof data.lat?"":baidu.template._encodeHTML(data.lat),'" class="hide_poi_address" poi_id="',"undefined"==typeof data.uid?"":baidu.template._encodeHTML(data.uid),'">                        </div>                        <div class="error-msg v-hide">请输入地址并在下拉框中进行选择</div>                        <div class="s-search-container2"></div>                                            </div>                </td>            </tr>            <tr>                <td valign="top"><span class="l-label">详细地址</span></td>                <td>                    <div class="form-group">                        <div class="input-control">                                                        <input type="text" name="detail_address" placeholder="请输入门牌号等详细信息" value="',"undefined"==typeof data.detail_address?"":baidu.template._encodeHTML(data.detail_address),'" class="placeholder-con">                        </div>                        <div class="error-msg v-hide">请输入门牌号等详细信息</div>                    </div>                </td>            </tr>        </table>        <div class="form-group form-submit">            <input type="button" class="saveBtn" data-node="saveBtn" value="'),confirmTxt?_template_fun_array.push("","undefined"==typeof confirmTxt?"":baidu.template._encodeHTML(confirmTxt),""):_template_fun_array.push("保存"),_template_fun_array.push('">            '),noCancel||_template_fun_array.push('                <input type="button" class="escBtn versa" value="取消">            '),_template_fun_array.push("        </div>    </form></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],GlobalTips=require("waimai:static/utils/GlobalTips"),cacheDialog;window.NOBLUR="NOPE";var CookieDataCenter=require("waimai:static/utils/CookieDataCenter"),SearchForSug=require("waimai:widget/common/ui/search/search"),ADD_AJAX="/waimai?qt=addressmanage&type=add&display=json",UPDATE_AJAX="/waimai?qt=addressmanage&type=update&display=json",REMOVE_AJAX="/waimai?qt=addressmanage&type=del&display=json",SETDEFAULT_AJAX="/waimai?qt=addressmanage&type=set&display=json",_opt={data:[],$listEl:null,$addBtn:null,$detailEl:null,listComplete:null,itemRemove:null,dialogShow:null,saveSuccess:null,reForm:!0};$.extend(Address.prototype,{checkTotal:function(){var e=this.opt.$listEl.find("li.addr-item:not('.addr-add')").length;e>=10?this.opt.$addBtn.addClass("hide"):this.opt.$addBtn.removeClass("hide")},bindEvent:function(){var e=this.opt.$listEl,t=this;e.on("click",".addr-edit",function(e){var a={},i=$(this).closest("li").attr("data-msg"),d=i.split("$");a.id=$(this).closest("li").attr("data-id"),a.user_name=d[0],a.gender=d[1],a.user_phone=d[2],a.sug_address=d[3],a.detail_address=d[4],a.lng=d[5].split(",")[0],a.lat=d[5].split(",")[1],a.uid=d[6],t.showDetailDialog(a),e.preventDefault(),e.stopPropagation()}),e.on("click",".addr-remove",function(e){t.removeAddress($(this).closest("li")),window.Search.resetMyAddress(),e.preventDefault(),e.stopPropagation()}),this.opt.$addBtn&&this.opt.$addBtn.on("click",function(){var e=t.opt.$listEl.find("li.addr-item:not('.addr-add')").length;return e>=10?void t.errorTip("最多只能添加10个送货地址"):void t.showDetailDialog()}),$(this).on("listComplete",function(){this.opt.listComplete&&this.opt.listComplete(t);var e=$(".new-address-section");this.initSugEvent(e),$(document).on("click",function(){e.find(".s-selected").hide(),e.find(".s-search-container2").hide()})}),$(this).on("dialogShow",function(){this.opt.dialogShow&&this.opt.dialogShow(t)}),this.opt.$detailEl&&(this.opt.$detailEl.on("click",".saveBtn",function(){t.saveAddress()}),this.opt.$detailEl.on("click",".escBtn",function(){t.cacheDialog.hide({fade:!0})})),$(this).on("saveSuccess",function(e,a){this.opt.saveSuccess?(this.opt.saveSuccess(t,a),window.Search.resetMyAddress()):(t.cacheDialog.hide({fade:!0}),this.successTip("保存成功，正在刷新..."),setTimeout(function(){window.location.reload()},1500))}),$(this).on("itemRemove",function(e,a){window.Search.resetMyAddress(),this.opt.itemRemove&&t.opt.itemRemove(t,a)})},initList:function(){this.opt.data;this.opt.data&&this.opt.data.length>0&&(this.opt.data.uid||(this.opt.data.uid=""),this.opt.$listEl.prepend(listTmpl({data:this.opt.data}))),$(this).trigger("listComplete")},initSugEvent:function(e){var t=this,a=e,i=a.find(".s-search-container2"),d=a.find(".poi_address"),s=a.find(".poi_address"),n=a.find(".hide_poi_address");SearchForSug.init({$resultEl:i,$searchConEl:d,showHistoryTrg:"address.show.history",hideHistoryTrg:"address.hide.history",NOListLiJump:"NOPE",$hiddenSearchPOI:n}),s.on("click",function(e){t.showSearch(a),e.stopPropagation()}),$(".mod-dialog-wrap").on("click",function(e){i.hide(),e.stopPropagation()}),d.on("blur",function(){"NOPE"==window.NOBLUR&&t.checkForm("SUG")})},showSearch:function(e){var t=e.find(".poi_address");t.focus(),$(Search).trigger("hide.history")},bindGenderEvent:function(e){e.on("click",".s-gender",function(){if(!$(this).hasClass("selected")){$(".s-gender").removeClass("selected"),$(this).addClass("selected");var e=$(this).attr("data-gender");$(this).parent().find("[name='gender']").val(e)}})},showDetailDialog:function(e){var t=e?e:{},a=detailTeml({data:t,noCancel:!1,confirmTxt:"保存"});this.cacheDialog=new Dialog({html:a,width:560,height:400}),this.cacheDialog.show({fade:!0}),this.opt.$detailEl=$(".addr-detail.new-address-section"),$(".placeholder-con").placeholder(),this.bindGenderEvent(this.opt.$detailEl),$(this).trigger("dialogShow"),this.initSugEvent(this.opt.$detailEl)},removeAddress:function(e){var t=e.attr("data-id");try{$.ajax({url:REMOVE_AJAX,type:"GET",dataType:"json",data:{id:t,bdstoken:$("#bdstoken").val()},context:this,success:function(a){if(0==a.error_no)e.fadeOut(),e.remove(),this.successTip("送餐地址删除成功"),$(this).trigger("itemRemove",t);else{var i=a.error_msg?a.error_msg:"服务器累了，请稍后重试";this.errorTip(i)}}})}catch(a){"undefined"!=typeof alog&&alog("exception.fire","catch",{msg:a.message||a.description,path:"waimai:widget/common/ui/address/address.js",ln:258})}},saveAddress:function(){if(this.errorHide(),this.checkForm()){var e=this.getFormData();e.bdstoken=$("#bdstoken").val();var t=e.id?UPDATE_AJAX:ADD_AJAX;try{$.ajax({url:t,type:"POST",dataType:"json",data:e,context:this,success:function(t){if(0==t.error_no)e.__type=e.id?"update":"add",e.id=e.id||t.result.id||"",$(this).trigger("saveSuccess",e);else{var a=t.error_msg?t.error_msg:"服务器累了，请稍后重试";this.errorTip(a)}}})}catch(a){"undefined"!=typeof alog&&alog("exception.fire","catch",{msg:a.message||a.description,path:"waimai:widget/common/ui/address/address.js",ln:286})}}},checkForm:function(e){var t=e?1:0;if(t){var a=this.getInputValue("sug_address"),i=this.opt.$detailEl.find(".hide_poi_address").val();return(!$.trim(a)||a.length>40||!i)&&this.errorShow("sug_address"),!1}var d=this.getInputValue("user_name");if(!$.trim(d)||d.length>8)return this.errorShow("user_name"),!1;var s=this.getInputValue("gender");if(!s)return this.errorShow("gender"),!1;var n=this.getInputValue("user_phone");if(!/^1[3|4|5|7|8][0-9]\d{8}$/.test(n))return this.errorShow("user_phone"),!1;var a=this.getInputValue("sug_address"),i=this.opt.$detailEl.find(".hide_poi_address").val();return!$.trim(a)||a.length>40||!i?(this.errorShow("sug_address"),!1):!0},getFormData:function(){for(var e=this.opt.$detailEl.find(".input-control"),t={},a=0,i=e.length;i>a;a++){var d=e.eq(a),s=d.find("input").length?d.find("input").attr("name"):d.find("textarea").attr("name");t[s]=this.getInputValue(s)}t.id=this.getInputValue("adrr_id");var n=e.find(".hide_poi_address").val(),r=e.find(".hide_poi_address").attr("poi_id");return r&&void 0!=r&&"undefined"!=r||(r=""),t.lng=n.split("-")[0]?n.split("-")[0]:"",t.lat=n.split("-")[1]?n.split("-")[1]:"",t.location=n,t.poi_id=r,t.address=t.sug_address+" "+t.detail_address,t},successTip:function(e){GlobalTips.tip(e)},errorTip:function(e){GlobalTips.tip(e)},errorShow:function(e){$("[name='"+e+"']").parent().next().removeClass("v-hide"),$("[name='"+e+"']").addClass("caution-line"),this.errorHide(2500,e)},errorHide:function(e,t){var e=e?e:0,t=t?t:"";return e?void setTimeout(function(){$(".error-msg").addClass("v-hide"),t&&$("[name='"+t+"']").removeClass("caution-line")},e):void $(".error-msg").addClass("v-hide")},getInputValue:function(e){var t=this.opt.$detailEl.find("[name='"+e+"']"),a=t.get(0).tagName.toLowerCase(),i=t.attr("type"),d=function(){var t=$(" input[name='"+e+"']").filter(":checked");return t.length?t.val():null},s=function(){var t=[],a=$(" input[name='"+e+"']:checkbox");if(len=a.length,len>0)for(var i=0;len>i;i++)a[i].checked&&t.push(a[i].value);return t},n=function(){return t.val()};switch(a){case"input":switch(i){case"radio":return d();case"checkbox":return s();default:return n()}break;case"select":return n();case"textarea":return n();default:return null}},addFormHtml:function(){return detailTeml({data:{},noCancel:!0,confirmTxt:"保存送餐信息"})},updateOpt:function(e){this.opt=$.extend({},this.opt,e)}}),module.exports=Address});