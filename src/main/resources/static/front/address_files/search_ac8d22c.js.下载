define("waimai:widget/common/ui/navSearch/search",function(require,exports,module){function Search(e,t){this.setMyAddress(),this.initOption(t),this.initHtml(),this.bindEvent(e)}var Dialog=require("jsmod/ui/dialog"),CookieDataCenter=require("waimai:static/utils/CookieDataCenter"),AddressDataCenter=require("waimai:static/utils/AddressDataCenter"),addressEditDialog=require("waimai:widget/common/ui/addressEditDialog/addressEditDialog");require("waimai:static/utils/statis");var resultTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="search-title">    <div class="search-desc">请确定您的地址</div></div><div class="search-list s-list">    <ul>        ');for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('            <li data-uid = "',"undefined"==typeof item.uid?"":baidu.template._encodeHTML(item.uid),'" data-link = "/waimai?qt=shoplist&lat=',"undefined"==typeof item.latitude?"":baidu.template._encodeHTML(item.latitude),"&lng=","undefined"==typeof item.longitude?"":baidu.template._encodeHTML(item.longitude),"&address=","undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),"&city_id=","undefined"==typeof city_id?"":baidu.template._encodeHTML(city_id),'" data-msg = "',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),"$","undefined"==typeof(item.address?item.address:"")?"":baidu.template._encodeHTML(item.address?item.address:""),"$","undefined"==typeof item.latitude?"":baidu.template._encodeHTML(item.latitude),"$","undefined"==typeof item.longitude?"":baidu.template._encodeHTML(item.longitude),"$","undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"$","undefined"==typeof city_id?"":baidu.template._encodeHTML(city_id),'" data-name="',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'">                <div class="addr addr-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</p>                    <p class="addr-desc">',"undefined"==typeof(item.address?item.address:"")?"":baidu.template._encodeHTML(item.address?item.address:""),"</p>                    "),item.shopnum&&0!==parseInt(item.shopnum,10)?_template_fun_array.push('                        <p class="addr-shop-num">',"undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"家餐厅</p>                    "):_template_fun_array.push('                        <p class="addr-shop-num addr-no-open">暂无开通</p>                    '),_template_fun_array.push("                </div>            </li>        ")}_template_fun_array.push("    </ul></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],historyTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';if(eval(_template_varName),_template_fun_array.push(""),historyaddr&&historyaddr.length){_template_fun_array.push('    <h5>历史纪录</h5>    <ul class="nav-sug-list nav-sug-dish-list">        ');for(var i=0;i<historyaddr.length;i++){var item=historyaddr[i];_template_fun_array.push('            <li class="s-list-history" data-link="/waimai?qt=shoplist&lat=',"undefined"==typeof item.lat?"":baidu.template._encodeHTML(item.lat),"&lng=","undefined"==typeof item.lng?"":baidu.template._encodeHTML(item.lng),"&address=","undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),"&city_id=","undefined"==typeof decodeURIComponent(item.city_id)?"":baidu.template._encodeHTML(decodeURIComponent(item.city_id)),'" data-name="',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'">                <div class="addr his-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'</p>                    <p class="addr-desc">',"undefined"==typeof decodeURIComponent(item.address)?"":baidu.template._encodeHTML(decodeURIComponent(item.address)),"</p>                    "),item.shopnum&&0!==parseInt(item.shopnum,10)?_template_fun_array.push('                        <p class="addr-shop-num">',"undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"家外卖餐厅</p>                    "):_template_fun_array.push('                        <p class="addr-shop-num addr-no-open">暂无开通</p>                    '),_template_fun_array.push("                </div>            </li>        ")}_template_fun_array.push('        <li class="search-history-clear"><a class="clear-btn">清空历史记录</a></li>    </ul>')}_template_fun_array.push(""),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],myAddressTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';if(eval(_template_varName),_template_fun_array.push(""),myaddr){if(_template_fun_array.push('    <h5>我的收餐地址</h5>    <div class="search-list-my-address-block">    '),myaddr.length){_template_fun_array.push('        <ul class="my-address-list">            ');for(var i=0;i<myaddr.length;i++){var item=myaddr[i];if(5>i){var lat=0,lng=0;item.location&&2==item.location.split(",").length&&(lng=item.location.split(",")[0],lat=item.location.split(",")[1]),_template_fun_array.push('                <li class="s-list-myaddress" data-link="/waimai?qt=shoplist&lat=',"undefined"==typeof lat?"":baidu.template._encodeHTML(lat),"&lng=","undefined"==typeof lng?"":baidu.template._encodeHTML(lng),"&address=","undefined"==typeof decodeURIComponent(item.sug_address)?"":baidu.template._encodeHTML(decodeURIComponent(item.sug_address)),'&city_id=" data-sugaddress="',"undefined"==typeof item.sug_address?"":baidu.template._encodeHTML(item.sug_address),'" data-addr="',"undefined"==typeof JSON.stringify(item)?"":baidu.template._encodeHTML(JSON.stringify(item)),'">                    <span class="myaddr-info">',"undefined"==typeof item.user_name?"":baidu.template._encodeHTML(item.user_name),"&nbsp;","undefined"==typeof(1==item.gender?"先生":"女士")?"":baidu.template._encodeHTML(1==item.gender?"先生":"女士"),"&nbsp;","undefined"==typeof item.user_phone?"":baidu.template._encodeHTML(item.user_phone),'</span>                    <span class="myaddr-address">',"undefined"==typeof(item.sug_address||item.address)?"":baidu.template._encodeHTML(item.sug_address||item.address),"</span>                </li>            ")}}_template_fun_array.push("        </ul>    ")}else _template_fun_array.push('        <a class="search-address-add-btn" href="javascript:;">            <span class="icon-search-add"><i></i><i></i></span>新增地址        </a>    ');_template_fun_array.push("    </div>")}_template_fun_array.push(""),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],sugTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="search-list s-list">    <ul>        ');for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('            <li data-name="',"undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),'" data-lat="',"undefined"==typeof item.lat?"":baidu.template._encodeHTML(item.lat),'" data-lng="',"undefined"==typeof item.lng?"":baidu.template._encodeHTML(item.lng),'">                <div class="addr addr-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),'</p>                    <p class="addr-desc">',"undefined"==typeof item.name1?"":baidu.template._encodeHTML(item.name1),"","undefined"==typeof item.name2?"":baidu.template._encodeHTML(item.name2),"","undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),"</p>                </div>            </li>        ")}_template_fun_array.push("    </ul></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],emptyTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push("<p>此地点附近暂时没有外卖餐厅，努力覆盖中...</p>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];$.extend(Search.prototype,{opt:{$resultEl:null,$searchConEl:null,$searchBtn:null,showHistoryTrg:null,hideHistoryTrg:null,NOListLiJump:null,$hiddenSearchPOI:null},setDefaultAddress:function(e){$.ajax({url:"/waimai/user/address/updatelastusedtime?address_id="+e,type:"GET",dataType:"json",async:!1,cache:!1,success:function(){}})},varobj:{addressData:null,_historyHtml:""},initOption:function(e){$.extend(this.opt,e)},initHtml:function(){this.opt.$resultEl.addClass("mod-search-hide mod-search-container")},hideResult:function(){this.opt.$resultEl.addClass("mod-search-hide")},setItemTopAttr:function(){for(var e=this.opt.$resultEl.find(".s-list li"),t=this.opt.$resultEl.offset().top,a=0,d=e.length;d>a;a++){var s=e.eq(a).offset().top,i=e.eq(a).outerHeight(!0),n=s-i-t;e.eq(a).attr("data-top",n)}},showHistory:function(){var e;this.opt.$resultEl.empty().removeClass("mod-search-result mod-search-sug mod-search-empty").addClass("mod-search-history"),e=this.getHistoryTemplate(),e?(this.opt.$resultEl.removeClass("mod-search-hide").append('<div class="s-list search-list history-s-list">'+e+"</div>").show(),this.setItemTopAttr()):this.opt.$resultEl.addClass("mod-search-hide")},hideHistory:function(){this.opt.$resultEl.hide().empty().removeClass("mod-search-history").addClass("mod-search-hide")},showSug:function(e){this.opt.$resultEl.empty().removeClass("mod-search-hide mod-search-result mod-search-history mod-search-empty").addClass("mod-search-sug").append(e).show(),this.setItemTopAttr(),this.hideLoading()},showResult:function(e){this.opt.$resultEl.empty().removeClass("mod-search-hide mod-search-sug mod-search-history mod-search-empty").addClass("mod-search-result").append(e).show(),this.setItemTopAttr(),this.hideLoading()},showEmpty:function(){if(this.opt.NOListLiJump)this.opt.$hiddenSearchPOI.val("0-0"),this.hideResult();else{var e=emptyTmpl();this.opt.$resultEl.empty().removeClass("mod-search-hide mod-search-sug mod-search-history mod-search-result").addClass("mod-search-empty").append(e).show(),this.hideLoading()}},showLoading:function(){$(".s-loading").removeClass("mod-search-hide")},hideLoading:function(){$(".s-loading").addClass("mod-search-hide")},stopBubble:function(e){e.preventDefault(),e.stopPropagation()},setMyAddress:function(){var e=this;this.varobj.addressData=null,$.ajax({url:"/waimai/user/address/select?display=json",type:"GET",cache:!1,dataType:"json",success:function(t){t&&0==t.error_no?e.varobj.addressData=t.result&&t.result.data&&$.isArray(t.result.data)&&t.result.data.length?t.result.data:[]:t&&1102!=t.error_no&&e.addressLoadFaild(),t&&t._bdstoken&&$("#bdstoken").val(t._bdstoken)},error:function(){e.addressLoadFaild()}})},resetMyAddress:function(){$.extend(this.varobj,{addressData:null,_historyHtml:""}),this.hideResult(),this.setMyAddress()},getHistoryTemplate:function(){if(!this.varobj._historyHtml){{var e={myaddr:this.varobj.addressData,historyaddr:AddressDataCenter.getAll()||[]},t=myAddressTmpl(e);historyTmpl(e)}t&&addNStat({da_src:"navSearchAddressMyAddressList",da_act:"show",da_trd:"waimai"}),this.varobj._historyHtml=myAddressTmpl(e)+historyTmpl(e)}return this.varobj._historyHtml},addressAddPosition:function(e){if(e&&e.id){var t="dialog-s-list-myaddress-not-position",a="."+t,d=$(a);d.length||(d=$('<div class="'+t+'"><div class="dslm-container"><p>我们在地图上找不到您的位置<br />为了更好的为您服务，求告知～</p><p><input type="button" class="dslm-go-set-btn" value="去添加" /></p></div></div>').appendTo("body")),d.show().undelegate(".dslm-go-set-btn","click").delegate(".dslm-go-set-btn","click",function(){d.hide(),addressEditDialog.showDetailDialog(e,!0,!0)})}},addressLoadFaild:function(){var e=this,t="dialog-s-list-myaddress-not-position",a="."+t,d=$(a);d.length||(d=$('<div class="'+t+'"><div class="dslm-container"><div class="dslm-title">我的收餐地址<a class="dslm-close-link" href="javascript:;"></a></div><p>加载失败</p><p><input type="button" class="dslm-addr-reload-btn" value="重新加载" /></p></div></div>').appendTo("body")),d.show().undelegate(".dslm-addr-reload-btn","click").delegate(".dslm-addr-reload-btn","click",function(){d.hide(),addNStat({da_src:"navSearchAddressMyAddressListReloadBtn",da_act:"click",da_trd:"waimai"}),e.setMyAddress()}).undelegate(".dslm-close-link","click").delegate(".dslm-close-link","click",function(){d.hide(),addNStat({da_src:"navSearchAddressMyAddressListCloseReloadBtn",da_act:"click",da_trd:"waimai"})})},getSug:function(e){var t=this,a=CookieDataCenter.getCity()?CookieDataCenter.getCity().code:null;e=e||this.opt.$searchConEl.val(),$.ajax({url:"/waimai?qt=poisug",type:"POST",dataType:"json",data:{cid:a,type:0,wd:e,from:"pc"},success:function(a){var d=a.s||[],s="",i=[];d.length>0&&(t.opt.NOListLiJump?($.each(d,function(t,a){{var d=a.split("$"),s=d[3],n=d[5].split(",")[0],l=d[5].split(",")[1];s.replace(e,"<b>"+e+"</b>")}i.push({name1:d[0],name2:d[1],name3:s,lat:n,lng:l})}),s=sugTmpl({data:i})):(s="<div class='search-list s-list'><ul>",$.each(d,function(t,a){var d=a.split("$"),i=d[3],n=d[5].split(",")[0],l=d[5].split(",")[1],o="<i></i><span>"+i.replace(e,"<b>"+e+"</b>")+"</span>";s+="<li data-name='"+i+"' data-lat='"+n+"' data-lng='"+l+"'>"+o+"</li>"}),s+="</ul></div>"),t.showSug(s))}})},goShopList:function(e,t){if(e&&e.id){var a=e.lat||0,d=e.lng||0,s=e.sug_address||"";a||d||!e.location||2!=e.location.split(",").length||(d=e.location.split(",")[0],a=e.location.split(",")[1]);var i="/waimai?qt=shoplist&lat="+a+"&lng="+d+"&address="+s;if(t)return i;window.location.href=i}},goSearch:function(e,t,a){this.showLoading(),e=e||this.opt.$searchConEl.val(),!t&&(t=""),!a&&(a="");var d=this,s="",i="/waimai?qt=poisearch&from=pc&ie=utf-8&sug=0&tn=B_NORMAL_MAP&oue=1&res=1&c="+CookieDataCenter.getCity().code;addNStat({da_src:"findBk.searchBtn",da_act:"click",da_trd:"waimai"}),$.ajax({type:"GET",url:i,dataType:"json",data:{lat:t,lng:a,wd:e,_t:+new Date},timeout:1e4,success:function(e){if(0==e.error_no)if(""==e.result.url)if(d.opt.NOListLiJump&&1==e.result.content.length){var t=e.result.content[0].name||"",a=e.result.content[0].latitude||"0",i=e.result.content[0].longitude||"0";d.opt.$searchConEl.val(t),d.opt.$hiddenSearchPOI.val(i+"-"+a),d.hideResult()}else s=resultTmpl({data:e.result.content,city_id:e.result.city_id}),d.showResult(s);else{var n=e.result.content[0]||{shopnum:0};if(n.shopnum){var l={};$.extend(l,{name:n.name,address:n.address,lat:n.latitude,lng:n.longitude,shopnum:n.shopnum,city_id:e.result.city_id}),AddressDataCenter.add(l),d.opt.NOListLiJump?(d.opt.$searchConEl.val(l.name),d.opt.$hiddenSearchPOI.val(l.lng+"-"+l.lat),d.hideResult()):d.noonteaSearch(e.result.url)}else d.showEmpty()}else d.showEmpty()},error:function(){d.showEmpty()}})},enterOption:function(){var e=this.opt.$resultEl.find(".s-list li.s-on"),t=this.opt.$searchConEl.val();return e.length?void e.click():void(t&&this.goSearch(t,"",""))},listScroll:function(){var e,t=this.opt.$resultEl.find(".s-list li");if(t.length){if(this.opt.$resultEl.hasClass("mod-search-result")){if(t.size()<5)return}else if(t.size()<7)return;e=this.opt.$resultEl.find(".s-list li.s-on").attr("data-top"),this.opt.$resultEl.scrollTop(e)}},noonteaSearch:function(e){var t=/(\/shopinterface)|(\/activity)/;t.test(window.location.pathname)?(CookieDataCenter.setAddr({lng:this.getQueryString("lng",e),lat:this.getQueryString("lat",e),address:this.getQueryString("address",e)}),window.location.reload()):location.href=e},getQueryString:function(e,t){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),d=t.match(a);return null!=d?unescape(d[2]):null},bindEvent:function(e){var t=this,a=this.opt.$searchConEl,d=this.opt.$resultEl,s=this.opt.showHistoryTrg||"show.history",i=this.opt.hideHistoryTrg||"hide.history";$(e).on(s,function(){setTimeout(function(){t.showHistory()},0)}),$(e).on(i,function(){setTimeout(function(){t.hideHistory()},0)}),d.on("blur",function(){this.hide()}),a.on("click",function(e){var a=$(this).val(),d=CookieDataCenter.getCity();addNStat({da_src:"navSearchAddressInput",da_act:"focus",da_trd:"waimai"}),a?t.getSug(a):d.hasaoi||t.showHistory(),e.stopPropagation()}),a.on("keydown",function(e){if(window.NOBLUR="NOPE",t.opt.$hiddenSearchPOI&&t.opt.$hiddenSearchPOI.val(""),13==e.which)return void t.enterOption();if(38==e.which){var s,i,n=d.find(".s-list"),l=n.find("li.s-on");return void(n.length&&(0==l.length||0==l.index()?(n.find("li:last").addClass("s-on"),l.removeClass("s-on")):(l.prev("li").addClass("s-on"),l.removeClass("s-on")),s=n.find("li.s-on"),i=s.data("name"),t.listScroll(),i&&a.val(i)))}if(40==e.which){var s,i,n=d.find(".s-list"),l=n.find("li.s-on");return void(n.length&&(0==l.length||l.index()==n.find("li").length-1?(n.find("li:first").addClass("s-on"),l.removeClass("s-on")):(l.next("li").addClass("s-on"),l.removeClass("s-on")),s=n.find("li.s-on"),i=s.attr("data-name"),t.listScroll(),i&&a.val(i)))}setTimeout(function(){var e=a.val(),d=CookieDataCenter.getCity();e?t.getSug(e):d.hasaoi||t.showHistory()},0)}),d.on("click",".s-list li:not(.s-list-myaddress)",function(e){if(t.stopBubble(e),d.hasClass("mod-search-sug")){var a=$(e.currentTarget),s=a.data("name"),i=a.data("lat"),n=a.data("lng");return s&&t.opt.$searchConEl.val(s),void t.goSearch(s,i,n)}var l={},o=$(this).attr("data-msg"),r=$(this).attr("data-link");if(d.hasClass("mod-search-result")){if(!t.opt.NOListLiJump&&$(this).find(".addr-shop-num").hasClass("addr-no-open"))return;var m=o.split("$");$.extend(l,{name:m[0],address:m[1],lat:m[2],lng:m[3],shopnum:m[4],city_id:m[5]}),AddressDataCenter.add(l)}if(t.opt.NOListLiJump){for(var m=r.split("&"),u={},p=0;p<m.length;p++){var c=m[p].split("=")[0];val=m[p].split("=")[1],u[c]=val}$.extend(l,{name:u.address,lat:u.lat,lng:u.lng,city_id:u.city_id}),AddressDataCenter.add(l),t.opt.$searchConEl.val(u.address),t.opt.$hiddenSearchPOI.val(l.lng+"-"+l.lat),t.hideHistory()}else t.noonteaSearch(r)}),d.on("click",".s-list li.s-list-myaddress",function(e){t.stopBubble(e);var a=$(this).data("sugaddress"),d=$(this).data("addr").id;if(addNStat({da_src:"navSearchAddressMyAddressList",da_act:"click",da_trd:"waimai"}),a){var s=$(this).data("link");t.setDefaultAddress(d),window.location.href=s}else t.hideResult(),addNStat({da_src:"navSearchAddressAddSugAddressDialog",da_act:"show",da_trd:"waimai"}),t.addressAddPosition($(this).data("addr"))}),d.delegate(".search-address-add-btn","click",function(){addNStat({da_src:"navSearchAddressMyAddressList.addAddressBtn",da_act:"click",da_trd:"waimai"}),window.Search.hideResult(),addressEditDialog.showDetailDialog(null,!0,!0)}),d.on("mousedown",".s-list li",function(){window.NOBLUR="YES"}),d.on("click",".clear-btn",function(e){t.stopBubble(e),t.varobj._historyHtml=null,t.hideResult(),AddressDataCenter.clearAll(),d.empty()});var n=function(){t.hideResult()};$(document).on("click",n),d.hover(function(){$(document).unbind("click",n)},function(){$(document).on("click",n)}),a.hover(function(){$(document).unbind("click",n)},function(){$(document).on("click",n)})}}),module.exports={init:function(e){return new Search(this,e)}}});