define("waimai:widget/common/ui/setmeal/setmeal",function(require,exports,module){function setMeal(e){var t={data:[],$el:null,selectData:{},curGrp:0,selectBasic:{}};EventCenter=$({}),this.opt=$.extend(t,e),this.renderList(this.opt.data),this.bindEvent()}var stat=require("waimai:static/utils/statis"),cookie=require("wcommon:static/util/Cookie"),localStore=require("waimai:static/utils/store"),setMealTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="setMeal">    <div class="dish-title" data-node="setMeal-title">    </div>    <div class="content" data-node="setMeal-content">        <div class="groups" data-node="setMeal-content-groups">        </div>        <div class="dishes" data-node="setMeal-content-dishes">        </div>    </div>    <div class="bottom" data-node="setMeal-bottom">    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],setMealTitleTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<span class="closeBtn"></span><h2>',"undefined"==typeof data.itemName?"":baidu.template._encodeHTML(data.itemName),"</h2>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],setMealDishTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';if(eval(_template_varName),_template_fun_array.push('<div class="list-title">    <div class="big-tip">        '),_template_fun_array.push(parseInt(data.min_num)>=1?"            必选        ":"            可选        "),_template_fun_array.push("        "),parseInt(data.min_num)==parseInt(data.max_num)?(_template_fun_array.push("            "),1==data.min_num?_template_fun_array.push("            (单选)            "):_template_fun_array.push("            (多选 ","undefined"==typeof data.max_num?"":baidu.template._encodeHTML(data.max_num),"份)            "),_template_fun_array.push("        ")):_template_fun_array.push("            (多选 ","undefined"==typeof data.min_num?"":baidu.template._encodeHTML(data.min_num),"-","undefined"==typeof data.max_num?"":baidu.template._encodeHTML(data.max_num),"份)        "),_template_fun_array.push('    </div>    <span class="select-msg" data-node="selectmsg">&nbsp;            </span></div><div class="dishes-list '),selected&&selected.total&&selected.total.count>=data.max_num&&_template_fun_array.push(" enough"),_template_fun_array.push('">    '),data.ids.length>0){var len=data.ids.length,divider=Math.ceil(len/2)-1;_template_fun_array.push("        ");for(var i=0,len=data.ids.length;len>i;i++){var item=data.ids[i];if(_template_fun_array.push("            "),0==i&&_template_fun_array.push('                <div class="dish-c">            '),_template_fun_array.push("            "),parseInt(item.have_attr)||parseInt(item.have_feature)){_template_fun_array.push('            <div class="dish-item mutiple" data-id="',"undefined"==typeof item.item_id?"":baidu.template._encodeHTML(item.item_id),'" data-name="',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'" data-price="',"undefined"==typeof item.current_price?"":baidu.template._encodeHTML(item.current_price),'">                <div class="mutiple-title" data-node="mutipletitle">                    <span class="dish-name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</span>                    <span class="right-side">                        <span class="mutiple-box">                            多规格                        </span>                        <span class="dish-cost" data-node="dishCost">￥'),selected&&selected[item.item_id]&&selected[item.item_id].realPrice?_template_fun_array.push("","undefined"==typeof selected[item.item_id].realPrice?"":baidu.template._encodeHTML(selected[item.item_id].realPrice),""):_template_fun_array.push("","undefined"==typeof item.current_price?"":baidu.template._encodeHTML(item.current_price),""),_template_fun_array.push('</span>                        <span class="select-icon"></span>                    </span>                </div>                <div class="mutiple-content">                    <table class="size-table" data-node="sizeTable">                        ');for(var da in item.dish_attr)item.dish_attr[da].mainK=1;_template_fun_array.push("                        ");var attrs=_.extend(item.dish_features,item.dish_attr);for(var att in attrs){_template_fun_array.push('                        <tr data-key="',"undefined"==typeof att?"":baidu.template._encodeHTML(att),'" data-maink="'),_template_fun_array.push(attrs[att].mainK?"1":"0"),_template_fun_array.push('">                            <td class="attr-title" valign="top">',"undefined"==typeof att?"":baidu.template._encodeHTML(att),"：</td>                            <td>                                ");for(var j=0,attrlen=attrs[att].length;attrlen>j;j++)_template_fun_array.push('                                    <span class="s-item '),selected&&selected[item.item_id]&&-1!=_.indexOf(selected[item.item_id].features,attrs[att][j].id)&&_template_fun_array.push(" sec"),_template_fun_array.push('" data-price="',"undefined"==typeof attrs[att][j].price?"":baidu.template._encodeHTML(attrs[att][j].price),'"  data-id="',"undefined"==typeof attrs[att][j].id?"":baidu.template._encodeHTML(attrs[att][j].id),'"  data-name="',"undefined"==typeof attrs[att][j].name?"":baidu.template._encodeHTML(attrs[att][j].name),'">',"undefined"==typeof attrs[att][j].name?"":baidu.template._encodeHTML(attrs[att][j].name),"</span>                                ");_template_fun_array.push("                            </td>                        </tr>                        ")}_template_fun_array.push('                        <tr>                            <td colspan="2">                                <span class="select-box">                                    '),selected&&selected[item.item_id]&&selected[item.item_id].count?_template_fun_array.push('                                        <span class="minusicon" data-node="minusIcon"></span>                                        <span class="select_count">',"undefined"==typeof selected[item.item_id].count?"":baidu.template._encodeHTML(selected[item.item_id].count),'</span>                                        <span class="addicon" data-node="addIcon"></span>                                    '):_template_fun_array.push('                                        <span class="minusicon v-hide" data-node="minusIcon"></span>                                        <span class="select_count v-hide">0</span>                                        <span class="addicon disable" data-node="addIcon"></span>                                    '),_template_fun_array.push("                                </span>                            </td>                        </tr>                    </table>                </div>            </div>            ")}else _template_fun_array.push('            <div class="dish-item" data-id="',"undefined"==typeof item.item_id?"":baidu.template._encodeHTML(item.item_id),'" data-name="',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'" data-price="',"undefined"==typeof item.current_price?"":baidu.template._encodeHTML(item.current_price),'">                <span class="dish-name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</span>                <span class="right-side">                    <span class="select-box">                        '),selected&&selected[item.item_id]&&selected[item.item_id].count?_template_fun_array.push('                            <span class="minusicon" data-node="minusIcon"></span>                            <span class="select_count">',"undefined"==typeof selected[item.item_id].count?"":baidu.template._encodeHTML(selected[item.item_id].count),'</span>                            <span class="addicon" data-node="addIcon"></span>                        '):_template_fun_array.push('                            <span class="minusicon v-hide" data-node="minusIcon"></span>                            <span class="select_count v-hide">0</span>                            <span class="addicon" data-node="addIcon"></span>                        '),_template_fun_array.push('                    </span>                    <span class="dish-cost">￥',"undefined"==typeof item.current_price?"":baidu.template._encodeHTML(item.current_price),"</span>                </span>            </div>            ");_template_fun_array.push("            "),i==divider&&_template_fun_array.push('                </div><div class="dish-c">            '),_template_fun_array.push("            "),i==len-1&&_template_fun_array.push("                </div>            "),_template_fun_array.push("        ")}_template_fun_array.push("    ")}_template_fun_array.push("</div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],setMealGrpsTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push("");for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('    <div class="group-item '),curIndex==i&&_template_fun_array.push(" select"),_template_fun_array.push('" data-index="',"undefined"==typeof i?"":baidu.template._encodeHTML(i),'" data-grps-id="',"undefined"==typeof item.dish_group_id?"":baidu.template._encodeHTML(item.dish_group_id),'">        <span class="top-tip"></span>        '),_template_fun_array.push(parseInt(item.min_num)>0?'            <p class="gtitle">必选</p>        ':'            <p class="gtitle-not">可选</p>        '),_template_fun_array.push('        <p class="gname">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),"</p>    </div>    "),len-1>i&&_template_fun_array.push('        <div class="group-divider">            +        </div>    '),_template_fun_array.push("")}_template_fun_array.push('<span class="group-arrow" data-node="groupArrow"></span>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],setMealBotmTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<table width="100%">    <tr>        <td width="300">            套餐价：<span class="price" data-node="bottomprice" data-type="',"undefined"==typeof data.isFixedPrice?"":baidu.template._encodeHTML(data.isFixedPrice),'">￥'),1==parseInt(data.isFixedPrice)?_template_fun_array.push("","undefined"==typeof data.itemPrice?"":baidu.template._encodeHTML(data.itemPrice),""):_template_fun_array.push("0"),_template_fun_array.push("</span>        </td>        <td>            "),data.itemStock<50&&_template_fun_array.push("库存","undefined"==typeof data.itemStock?"":baidu.template._encodeHTML(data.itemStock),"份"),_template_fun_array.push("            "),data.itemStock<50&&data.minOrderNumber>1&&_template_fun_array.push(" | "),_template_fun_array.push("            "),data.minOrderNumber>1&&_template_fun_array.push("","undefined"==typeof data.minOrderNumber?"":baidu.template._encodeHTML(data.minOrderNumber),"份起订"),_template_fun_array.push('        </td>        <td>            <div class="select-outer disable" data-node="selectouter">                <div class="select-con">                    <div class="select-inner">                        <strong class="minusfrcart" data-node="minusfrcart"></strong>                        <strong class="select_count" data-node="selectCount">',"undefined"==typeof data.minOrderNumber?"":baidu.template._encodeHTML(data.minOrderNumber),'</strong>                        <strong class="addtocart" data-node="addtocart"></strong>                    </div>                </div>            </div>        </td>        <td width="170" align="center"><span class="submit-btn disable"  data-node="submitBtn">加入购物车</span></td>    </tr></table>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],dishListClass=".dishes-list",dishItemClass=".dish-item",mulItemClass="mutiple",grpItemClass=".group-item",seboxItemCls=".select-box",countItemCls=".select_count",EventCenter,GlobalTips=require("waimai:static/utils/GlobalTips");$.extend(setMeal.prototype,{renderList:function(e){var t=this.opt.$el;if(e&&e.groups.length>0){var a=setMealTmpl();t.html(a),t.find("[data-node=setMeal-title]").html(setMealTitleTmpl({data:e.basics})),t.find("[data-node=setMeal-content-groups]").html(setMealGrpsTmpl({data:e.groups,curIndex:this.opt.curGrp})),t.find("[data-node=setMeal-content-dishes]").html(setMealDishTmpl({data:e.groups[this.opt.curGrp],selected:{}})),t.find("[data-node=setMeal-bottom]").html(setMealBotmTmpl({data:e.basics})),$(this).trigger("list.complete")}},getRealLeftNum:function(){},bindEvent:function(){var e=this,t=e.opt.$el;t.find("[data-node=setMeal-title]").on("click",function(){}),t.find("[data-node=setMeal-content-groups]").on("click",grpItemClass,function(a){var n=$(a.currentTarget);e.switchGrps(n,t.find("[data-node=setMeal-content-groups]"))}),t.find("[data-node=setMeal-content-dishes]").on("click","[data-node=mutipletitle]","."+mulItemClass,function(e){var t=$(e.currentTarget);t.parents(dishItemClass).toggleClass("selected")}),t.find("[data-node=setMeal-content-dishes]").on("click","[data-node=sizeTable] .s-item","."+mulItemClass,function(t){var a=$(t.currentTarget);a.hasClass("sec")||(a.parents("tr").find(".s-item").removeClass("sec"),a.addClass("sec"),e.selectAttr(a),EventCenter.trigger("selectAttr"))}),t.find("[data-node=setMeal-bottom]").on("click","[data-node]",function(t){var a=$(t.currentTarget);e.handleBottomeClick(a)}),t.find("[data-node=setMeal-content-dishes]").on("click","[data-node=addIcon]",function(t){var a=$(t.currentTarget),n=a.parents(dishListClass);n.hasClass("enough")?GlobalTips.tip("已到达可选菜品上限"):a.hasClass("disable")&&GlobalTips.tip("多规格菜品需要先选择规格"),e.addIconClick(a)}),t.find("[data-node=setMeal-content-dishes]").on("click","[data-node=minusIcon]",function(t){var a=$(t.currentTarget);e.minusIconClick(a)}),EventCenter.on("selectAttr",function(){e.refreshSelectMsg(),e.refreshBottom()}),EventCenter.on("addDish",function(){e.onAddDish()}),EventCenter.on("minusDish",function(){e.onMinusDish()}),EventCenter.on("switchGrps",function(){e.refreshSelectMsg()})},switchGrps:function(e,t){var a=this,n=a.opt.$el,s=a.opt.data;t.find(grpItemClass).removeClass("select"),e.addClass("select"),a.opt.curGrp=e.data("index");var i=s.groups[a.opt.curGrp];n.find("[data-node=setMeal-content-dishes]").html(setMealDishTmpl({data:i,selected:a.opt.selectData[i.dish_group_id]})),a.setArrowPos(e),EventCenter.trigger("selectAttr")},setArrowPos:function(e){var t=this,a=t.opt.$el,n=e.position(),s=a.find("[data-node=groupArrow]");s.css({left:n.left+e.width()/2-s.width()/2+"px"})},selectAttr:function(e){var t=this,a=t.opt.data.groups[t.opt.curGrp],n=a.dish_group_id,s=t.opt.selectData[n]||{total:{count:0}},i=e.parents("[data-node=sizeTable]").find("[data-key]"),d=e.parents("[data-node=sizeTable]").find(".sec"),r=e.parents(dishItemClass).find("[data-node=dishCost]");if(d.length<i.length)return e.parents("[data-node=sizeTable]").find("[data-node=addIcon]").addClass("disable"),!1;e.parents("[data-node=sizeTable]").find("[data-node=addIcon]").removeClass("disable");var l=t.getItemInfo(e),o=l.id,p=[],u=[];s[o]=t.getItemSelectData(l,s[o]);for(var m=0,_=i.length;_>m;m++)"1"==$(i[m]).data("maink")&&(s[o].realId=$(i[m]).find(".sec").data("id")+"",s[o].realPrice=$(i[m]).find(".sec").data("price"),r.text("￥"+$(i[m]).find(".sec").data("price"))),p.push($(i[m]).find(".sec").data("id")+""),u.push($(i[m]).find(".sec").data("name"));return s[o].features=p,s[o].featueNames=u,"addIcon"==e.data("node")?s[o].count++:"minusIcon"==e.data("node")&&s[o].count--,t.opt.selectData[n]=s,!0},onAddDish:function(){var e=this;e.refreshTopTip(),e.refreshSelectMsg(),e.refreshBottom()},onMinusDish:function(){var e=this;e.refreshTopTip(),e.refreshSelectMsg(),e.refreshBottom()},refreshSelectMsg:function(){var e=this,t=e.opt.selectData,a=e.opt.data.groups,n=a[e.opt.curGrp],s=t[n.dish_group_id];s&&s.total&&parseInt(s.total.count)>=parseInt(n.max_num)?e.opt.$el.find(dishListClass).addClass("enough"):e.opt.$el.find(dishListClass).removeClass("enough");var i="&nbsp;";for(var d in s)"total"!=d&&s[d].count&&(i+=s[d].dname,s[d].featueNames&&s[d].featueNames.length&&(i+="_"+s[d].featueNames.join("_")),i+="*"+s[d].count+"、");e.opt.$el.find("[ data-node=selectmsg]").html(i)},refreshTopTip:function(){for(var e=this,t=e.opt.selectData,a=e.opt.data,n=0,s=a.groups.length;s>n;n++){var i=$("[data-grps-id="+a.groups[n].dish_group_id+"]").find(".top-tip");if(t[a.groups[n].dish_group_id]){var d=t[a.groups[n].dish_group_id].total.count;d&&a.groups[n].min_num<=d&&d<=a.groups[n].max_num?i.addClass("ready").text(t[a.groups[n].dish_group_id].total.count).show():d&&t[a.groups[n].dish_group_id].total.count>=0?i.removeClass("ready").text(t[a.groups[n].dish_group_id].total.count).show():i.hide()}}},refreshBottom:function(){for(var e=this,t=e.opt.$el,a=t.find("[data-node=bottomprice]"),n=t.find("[data-node=selectouter]"),s=t.find("[data-node=submitBtn]"),i=e.opt.selectData,d=e.opt.data.groups,r=[],l=0,o=0,p=d.length;p>o;o++)parseInt(d[o].min_num)&&r.push(i[d[o].dish_group_id]&&i[d[o].dish_group_id].total.count>=d[o].min_num?1:0),1===Math.min.apply(null,r)?(n.removeClass("disable"),s.removeClass("disable")):(n.addClass("disable"),s.addClass("disable"));if(1!==parseInt(a.data("type"))){for(var u in i){var m=i[u];if(m.total.count)for(var _ in m)"total"!==_&&m[_].count&&(l+=parseFloat(m[_].realPrice||m[_].price)*parseInt(m[_].count))}a.html("￥"+l.toFixed(2)),e.opt.selectBasic.price=l}else e.opt.selectBasic.price=e.opt.data.basics.itemPrice},refreshSelectArea:function(e,t,a){var n=e.parent();t[a.id].count>0?(n.find("[data-node=minusIcon]").removeClass("v-hide"),n.find(countItemCls).text(t[a.id].count).removeClass("v-hide")):(e.parent().find(countItemCls).text(t[a.id].count).addClass("v-hide"),n.find("[data-node=minusIcon]").addClass("v-hide"))},addIconClick:function(e){var t=this,a=t.opt.data.groups[t.opt.curGrp],n=parseInt(a.max_num),s=a.dish_group_id,i=t.opt.selectData[s]||{total:{count:0}},d=t.getItemInfo(e);if(i[d.id]=t.getItemSelectData(d,i[d.id]),e.parents(dishItemClass).hasClass(mulItemClass)&&i.total.count<n)t.selectAttr(e)&&i.total.count++;else{if(!(i.total.count<n))return;i.total.count++,i[d.id].count++}t.refreshSelectArea(e,i,d),t.opt.selectData[s]=i,EventCenter.trigger("addDish")},getItemSelectData:function(e,t){return t=t||{count:0,dname:e.name,price:e.price}},getItemInfo:function(e){var t=e.parents(dishItemClass),a="";a=t.data("id")+"";var n=t.data("name"),s=t.data("price");return{id:a,name:n,price:s,count:0}},minusIconClick:function(e){var t=this,a=t.opt.data.groups[t.opt.curGrp],n=(parseInt(a.min_num),a.dish_group_id),s=t.opt.selectData[n]||{total:{count:0}},i=t.getItemInfo(e);if(s[i.id]=t.getItemSelectData(i,s[i.id]),e.parents(dishItemClass).hasClass(mulItemClass)&&s[i.id].count>=1)t.selectAttr(e)&&s.total.count--;else{if(s[i.id].count<=0)return void(s[i.id].count=0);s.total.count--,s[i.id].count--}t.refreshSelectArea(e,s,i),t.opt.selectData[n]=s,EventCenter.trigger("minusDish")},handleBottomeClick:function(e){var t=this,a=t.opt.data.basics,n=e.data("node"),s=t.opt.$el.find("[data-node=selectCount]"),i=parseInt(s.html())||0;"addtocart"===n?i&&i<a.itemStock?s.html(++i):i||s.html(a.minOrderNumber):"minusfrcart"===n&&s.html(i<=a.minOrderNumber?0:--i),t.opt.data.basics.itemCount=i,"submitBtn"===n&&!e.hasClass("disable")&&t.submitSetMeal()},adjustDataStructure:function(e){e.orignItemId=e.itemId,e.grpsInfo.basic.id=e.itemId,e.itemPrice=e.grpsInfo.basic.price,e.type="append";var t=[],a=[],n=[];for(var s in e.grpsInfo.data){var i=e.grpsInfo.data[s];t.push(s+"_p"+i.total.count);for(var d in i)"total"!==d&&(a.push(d+"_p"+i[d].count),i[d].features&&i[d].features.length&&n.concat(i[d].features))}e.itemId=t.sort().join("__")+"___"+a.sort().join("__")+"___"+n.sort().join("__")},saveGrpsData:function(e){e.grpsInfo&&localStore.set("s"+e.itemId+"s",e.grpsInfo)},submitSetMeal:function(){var e=this,t={};t=$.extend(t,e.opt.data.basics),t.grpsInfo={basic:e.opt.selectBasic,data:e.opt.selectData},e.adjustDataStructure(t),e.saveGrpsData(t),e.opt.onSubmitBtn(t)}}),module.exports=setMeal});